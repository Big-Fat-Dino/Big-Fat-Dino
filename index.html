<html>
  <head>
    <title>Big Fat Dino</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="shortcut icon" type="image/png" href="assets/logo-green-transparent.png"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous"></script>
    <link href="dependencies/fontawesome/css/all.css" rel="stylesheet">
    <link href="assets/style.css" rel="stylesheet">
    </head>
  <body  onmousemove="mouseX = event.clientX; mouseY =  event.clientY;" >
    <div id="loading-big">
      <div id="spinner-container">
        <i class="fas fa-spinner"></i>
      </div>
    </div>
    <!--<webview id="contents" preload="./preloader.js" src=""  style="width:1280px; height:720px" partition"persist:link" ></webview>-->

    <script>
      //console.log = function () { };

    </script>



    <script>

      function getDom(){
        return(document.getElementById("contents").innerHTML);
      }

    /*  async function readFileAsync(path){
        fs.readFile(path, "utf8", (err, data) => {
          console.log(data);
          resolve(data);
        });
      }*/





    function callAgent(args) {
        return new Promise(resolve => {
            ipcRenderer.send('asynchronous-message', args);
            ipcRenderer.on('asynchronous-reply', (event, result) => {
                resolve(result);
            });
        });
    }
    </script>
    <script>

        /*
        var exec = require('child_process').exec;
        const fs = require("fs");*/
        const { app, BrowserWindow, screen } = require('electron');


        const {ipcRenderer} = require('electron');


        function adjustWindowSize(width, height){
          ipcRenderer.send('resize-window', width, height );
        }

        function maximiseWindow(){
          ipcRenderer.send('maximise-window');
        }


        //Image downloader, window resizer, command executer and read and write file functions need to be moved to main. Basically anything that requires a node module.

        function writeFile (path, content){
          return new Promise(resolve => {
              ipcRenderer.send('writefile', path,content);
              ipcRenderer.on('writefile-error', (event, err, writtenPath) => {
                if(writtenPath == path){
                  throw err;
                  resolve(err);
                }

              });
              ipcRenderer.on('writefile-return', (event, writtenPath) => {
                if(writtenPath == path){
                  resolve("file written");
                }
              });
          });
        }
        /*
          function readfile(path){
            var data = fs.readFileSync(path, "utf8");
            return data;
          }
*/

          function readfile(path) {
            return new Promise(resolve => {
                ipcRenderer.send('readfile', path);
                ipcRenderer.on('readfile-return', (event, data, readPath) => {
                  if(readPath == path){
                    resolve(data);
                  }

                });


            });
          }


          // this should be in index.js;
          /*
          async function execute(command, callback) {
              await exec(command, (error, stdout, stderr) => {
                   callback(stdout);
              });
          };

          async function command(command){
            await execute(command,  (output) =>   {
              console.log(output);
            });
          }
          */
          function openUrlInBrowser(url){
            ipcRenderer.send('openUrlInBrowser', url);
          }
          var backgroundSyncActive = false;
          function URLExists (url, overRideBackgroundSyncSetting = false) {
            if(userinfo["__"]["existingUrls"].includes(url)){
              return true;
            }else{
              if(backgroundSyncActive && !overRideBackgroundSyncSetting){
                return false;
              }else{
                try{
                  var http = new XMLHttpRequest();
                  http.open('HEAD', url, false);
                  http.send();
                }catch(e){
                  return false;
                }if(http.status != 404){
                    userinfo["__"]["existingUrls"].push(url);
                    return true;
                  }

                else{
                  return false;
                }
              }

            }

          }







          function fetchInstalledGames(){

            var x = 0;

            while(x<usergames.length){
              try{
                if(usergames[x]["installed-platforms"].includes("custom")){
                  usergames[x]["installed-platforms"] = ["custom"];
                  usergames[x]["installed"] = true;
                }else{
                  usergames[x]["installed-platforms"] = [];
                  usergames[x]["installed"] = false;
                }
              }catch{

              }

              x++;
            }
            fetchInstalledSteam();
            fetchInstalledLutris();


            var detectinstalledcomplete = false;

            waitforComplete = setInterval( async function(){
                var x = 0;
              if(steamInstalledIDs.length > 0 & lutrisInstalledSlugs.length > 0 & detectinstalledcomplete === false){
                detectinstalledcomplete = true;
                while(x<steamInstalledIDs.length){

                  var position = usergamesSTEAMID(steamInstalledIDs[x], true);
                  if(position !== "not found"){
                    console.log(usergames[position]);
                    usergames[position]["installed"] = true;
                    if(typeof usergames[position]["installed-platforms"] === "undefined"){
                      usergames[position]["installed-platforms"] = [];
                    }
                    if(!usergames[position]["installed-platforms"].includes("steam")){
                      usergames[position]["installed-platforms"].push("steam");
                    }
                  }
                  x++;
                }

                var x=0;

                while(x<lutrisInstalledSlugs.length){
                  var slug = DBgameLutrisSLG(lutrisInstalledSlugs[x])["slug"];
                  if(slug == "not found" || typeof slug == "undefined"){
                    var slug = lutrisInstalledSlugs[x];
                  }
                  if( await DBgameSLG(lutrisInstalledSlugs[x]) == "not found"){
                    var slug = produceSlug(allLutrisGames[x]["name"]);
                  }
                  console.log(slug);
                  var position = usergamesSLG(slug, true);
                  console.log(position);
                  if(position !== "not found"){
                    usergames[position]["lutris-slug"] = lutrisInstalledSlugs[x];
                    console.log(usergames[position]);
                    usergames[position]["installed"] = true;
                    if(typeof usergames[position]["installed-platforms"] === "undefined"){
                      usergames[position]["installed-platforms"] = [];
                    }
                    if(!usergames[position]["installed-platforms"].includes("lutris")){
                      usergames[position]["installed-platforms"].push("lutris");
                    }
                  }
                  x++;
                }

              }
            }, 100);

          }

          var steamInstalledIDs = [];
/*
          function fetchInstalledSteam(){
            execute("lutris -s",  (output) =>   {
              var steamInstalledRaw = output.split("\n");
            //console.log(steamInstalledRaw);
              var x =0;
              while(x<steamInstalledRaw.length-1){
                steamInstalledIDs.push(gitBetween("***" + steamInstalledRaw[x].trim(), "***", " "))
                x++;
              }
            console.log(steamInstalledIDs);
            });


          }
*/


          function fetchInstalledSteam() {
              return new Promise(resolve => {
                  ipcRenderer.send('fetchInstalledSteam');
                  ipcRenderer.on('steam-installed', (event, steamInstalled) => {
                      steamInstalledIDs = steamInstalled;
                      console.log(steamInstalledIDs);
                      resolve(steamInstalledIDs);
                  });
              });
          }


          var lutrisInstalledSlugs = [];
          /*
          function fetchInstalledLutris(){
            execute("lutris -l -o -j",  (output) =>   {
              var lutrisInstalled = JSON.parse("[" + gitBetween(output, "[", "]") + "]");
            //console.log(lutrisInstalledRaw);


              var x =0;
              while(x<lutrisInstalled.length){
                console.log(lutrisInstalled[x]["directory"]);
                if(!lutrisInstalledSlugs.includes(lutrisInstalled[x]["slug"]) && lutrisInstalled[x]["directory"] !== "null" & lutrisInstalled[x]["directory"] !== ""){
                  lutrisInstalledSlugs.push(lutrisInstalled[x]["slug"]);
                }
                x++;
              }
              console.log(lutrisInstalledSlugs);
            });
          }*/
          var allLutrisGames = []
          function fetchInstalledLutris() {
              return new Promise(resolve => {
                  ipcRenderer.send('fetchInstalledLutris');
                  ipcRenderer.on('lutris-installed', (event, lutrisInstalledSlugs_, lutrisgames) => {
                      console.log(lutrisInstalledSlugs_);
                      resolve(lutrisInstalledSlugs_);
                      lutrisInstalledSlugs = lutrisInstalledSlugs_;

                      allLutrisGames = lutrisgames;
                  });
              });
          }
/*
          function fetchInstalledLutris(){
            execute("lutris -l -o ",  (output) =>   {
              var lutrisInstalledRaw = output.split("\n");
            //console.log(lutrisInstalledRaw);
              var x =0;
              while(x<lutrisInstalledRaw.length-1){
                var game = lutrisInstalledRaw[x].split(" | ");
              //console.log(game);
                if(!lutrisInstalledSlugs.includes(game[2].trim())){
                  lutrisInstalledSlugs.push(game[2].trim());
                }
                x++;
              }
              console.log(lutrisInstalledSlugs);
            });
          }
*/
  //    function fetchSteamProfile(profileName){
  //      fetch('https://steamcommunity.com/id/' . profileName . '/').then((response) => response.text()).then((text) => console.log(text));


  //    }
      var usergames = [];
      var steamApps = [];
      var steamuserid;
      function gitBetween(string, first, last){
        //console.log(string.indexOf(first));
        //console.log(string.indexOf(last));
        var partOne = string.substring(string.indexOf(first), string.length)
        //NICE!!
        return(partOne.substring(partOne.indexOf(first) + first.length, partOne.indexOf(last)));
      }
      function askForUsername(){

      }


      async function fetchSteamProfile(profileName) {

        userinfo["logins"]["username-steam"] = profileName;
        userinfo["config"]["synced-stores"].push("steam");

        steamuserid = profileName;
        var x = await fetch('https://steamcommunity.com/id/' + profileName + '/');
        var y = await x.text();
        console.log(String(y));
        var doc = new DOMParser().parseFromString(String(y), "text/html");
        console.log(doc);
        console.log(doc.title);
        var username = doc.getElementsByClassName("actual_persona_name")[0].innerHTML;
        document.getElementById("steam-name").innerHTML = username;
        var name = doc.getElementsByClassName("header_real_name ellipsis")[0].getElementsByTagName("bdi")[0].innerHTML;
        document.getElementById("steam-human-name").innerHTML = name;
        console.log (name);
        await fetchSteamGames(profileName);
        fetchSteamLastPlayedTimes();
        return;
      }



      function parseSteamReleaseDate(raw){
        //console.clear();
        var year = gitBetween(raw + "_", ", ", "_");
        var day = gitBetween(".." + raw, ".. ", " ");

        if (raw.includes("Jan")){
          var month = 1;
        }else if(raw.includes("Feb")){
          var month = 2;
        }else if(raw.includes("Mar")){
          var month = 3;
        }else if(raw.includes("Apr")){
          var month = 4;
        }else if(raw.includes("May")){
          var month = 5;
        }else if(raw.includes("Jun")){
          var month = 6;
        }else if(raw.includes("Jul")){
          var month = 7;
        }else if(raw.includes("Aug")){
          var month = 8;
        }else if(raw.includes("Sep")){
          var month = 9;
        }else if(raw.includes("Oct")){
          var month = 10;
        }else if(raw.includes("Nov")){
          var month = 11;
        }else if(raw.includes("Dec")){
          var month = 12;
        }
        var date = year + "-" + month + "-" + day;
        return (date);
      }




      function parseSteamAchievementDate(date){
        var month= parseSteamMonth(date);

        if(date.includes(",")){
          var day = gitBetween(date, "Unlocked ", ",").replace(/([a-zA-Z ])/g, "").trim();
          var year = gitBetween(date, ", ", "@").trim();
        }else{
          var d = new Date();
          var year = d.getFullYear();
          var day = gitBetween(date, "Unlocked", "@").replace(/([a-zA-Z ])/g, "").trim();
        }




        return(year + "-" + month  + "-" + day);
      }

      function parseGOGAchievementDate(date){

        if (date.includes("January")){
          var date = date.replace("January", "1");
        }else if (date.includes("February")){
          var date = date.replace("February", "2");
        }else if (date.includes("March")){
          var date = date.replace("March", "3");
        }else if (date.includes("April")){
          var date = date.replace("April", "4");
        }else if (date.includes("May")){
          var date = date.replace("May", "5");
        }else if (date.includes("June")){
          var date = date.replace("June", "6");
        }else if (date.includes("July")){
          var date = date.replace("July", "7");
        }else if (date.includes("August")){
          var date = date.replace("August", "8");
        }else if (date.includes("September")){
          var date = date.replace("September", "9");
        }else if (date.includes("October")){
          var date = date.replace("October", "10");
        }else if (date.includes("November")){
          var date = date.replace("November", "11");
        }else if (date.includes("December")){
          var date = date.replace("December", "12");
        }


        return(date.replaceAll(" ", "-").split("-").reverse().join("-"));
      }


      function parseOriginAchievementDate(date){

        if (date.includes("January")){
          var month =  "1"
        }else if (date.includes("February")){
          var month = "2"
        }else if (date.includes("March")){
          var month ="3"
        }else if (date.includes("April")){
          var month = "4"
        }else if (date.includes("May")){
          var month = "5"
        }else if (date.includes("June")){
          var month = "6"
        }else if (date.includes("July")){
          var month =  "7"
        }else if (date.includes("August")){
          var month = "8"
        }else if (date.includes("September")){
          var month = "9"
        }else if (date.includes("October")){
          var month = "10"
        }else if (date.includes("November")){
          var month = "11"
        }else if (date.includes("December")){
          var month = "12"
        }

        var day = gitBetween(date, "Completed:", ",").replace(/([a-zA-Z ])/g, "").trim();
        var year = gitBetween(date + "**__**", ",", "**__**").replace(/([a-zA-Z ])/g, "").trim();
        return(year + "-" + month + "-" + day);
      }


      function parseSteamMonth(raw){
        if (raw.includes("Jan") || raw.includes("jan")){
          var month = 1;
        }else if(raw.includes("Feb") || raw.includes("feb")){
          var month = 2;
        }else if(raw.includes("Mar") || raw.includes("mar")){
          var month = 3;
        }else if(raw.includes("Apr") || raw.includes("apr")){
          var month = 4;
        }else if(raw.includes("May") || raw.includes("may")){
          var month = 5;
        }else if(raw.includes("Jun") || raw.includes("jun")){
          var month = 6;
        }else if(raw.includes("Jul") || raw.includes("jul")){
          var month = 7;
        }else if(raw.includes("Aug") || raw.includes("aug")){
          var month = 8;
        }else if(raw.includes("Sep") || raw.includes("sep")){
          var month = 9;
        }else if(raw.includes("Oct") || raw.includes("oct")){
          var month = 10;
        }else if(raw.includes("Nov") || raw.includes("nov")){
          var month = 11;
        }else if(raw.includes("Dec") || raw.includes("dec")){
          var month = 12;
        }
        return (month);
      }



      async function fetchSteamLastPlayedTimes(){
        var profilePage = await getPageSourceHTML("https://steamcommunity.com/id/" + userinfo["logins"]["username-steam"] + "");

        var recentCards = profilePage.getElementsByClassName("recent_game_content");
        var x = 0;
        while(x<recentCards.length){
          var steamID = recentCards[x].getElementsByTagName("a")[0].href.replaceAll("https://steamcommunity.com/app/", "");
          var month = parseSteamMonth(recentCards[x].getElementsByClassName("game_info_details")[0].innerHTML);
          var year = 2021;
          var day = gitBetween(recentCards[x].getElementsByClassName("game_info_details")[0].innerHTML  + "***_*", "<br>", "***_*").replaceAll("last played on", "").replace(/([a-zA-Z ])/g, "").trim();
          console.log(day);
          var lastPlayed = year + "-" + month + "-" + day;
          if(usergamesSTEAMID(steamID) !== "not found"){
            usergames[usergamesSTEAMID(steamID, "true")]["last-played"] = lastPlayed;
          }
          x++;
        }
      }


      async function fetchSteamGames(profileName){
        var x = await fetch('https://steamcommunity.com/id/' + profileName + '/games/?tab=all&sort=name');
        var y = await x.text();
        console.log(String(y));
        var gamespage = new DOMParser().parseFromString(String(y), "text/html");
        var games = gitBetween(String(y), "var rgGames = ", ";");
        gameslist = JSON.parse(games);
        console.log(gameslist);
        console.log(gameslist.length);
        var z = 0;

        while (z < gameslist.length){

          assets = {};
          if(usergamesSTEAMID(gameslist[z]["appid"]) !== "not found"){

            game["assets"] = usergamesSTEAMID(gameslist[z]["appid"])["assets"];
            console.log(gameslist[z]);
            console.log("found");
          }else{
            if(URLExists("https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/page_bg_raw.jpg")){
              assets["background"] = "https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/page_bg_raw.jpg";
            }
            if(URLExists("https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/library_hero.jpg")){
              assets["hero"] = "https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/library_hero.jpg";
            }

            if(URLExists("https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/library_600x900.jpg")){
             assets["box"] = "https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/library_600x900.jpg";
             assets["header"] = "https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/header.jpg";
            }else{
              if(URLExists("https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/header.jpg")){
                assets["header"] = "https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/header.jpg";
              }
            }

            if(URLExists("https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/logo.png")){
              assets["logo"] = "https://cdn.cloudflare.steamstatic.com/steam/apps/" + gameslist[z]["appid"] + "/logo.png";
            }
          }






          game = {};
          game["name"] = gameslist[z]["name"];
          game["platforms"] = ["steam"];
          game["steamid"] = gameslist[z]["appid"];

          // this is a silly implementation. Ideally we should just crawl the Steam page for the product to see what product type it is.
          //if (await URLExists (assets["library-box"]) === true){
          //  game["type"] = "game";
          //}else{
          //  game["type"] = "other";
          //}
          game["slug"] = produceSlug(game["name"]);
          game["assets"] = assets;
          steamApps.push(game);
            console.log (gameslist[z]["name"])
            console.log(z)
          z++;
        }
        console.log(steamApps);
        getSteamAchievements();
        fetchSteamBadges();
        fetchSteamWishlist();
        return;

      //  populateLibrary();
      }




      function launchSteamGame(id){
        ipcRenderer.send('launchSteamGame', id);
      }
      function launchLutrisGame(id){
        ipcRenderer.send('launchLutrisGame', id);
      }

      async function installGame(slug){
        document.getElementById("game-install").remove();
        document.getElementById("modal").innerHTML+= `<div id="game-install">

          <div class="modal-content" id="add-game">
            Please select a platform to install the game from
            <div class="modal-button-big-container">



            </div>
          </div>
        </div>`;
        openModal("game-install");
        var game = usergamesSLG(slug);


        var steamID = game["steamid"];

        if(typeof (steamID) == "undefined"){
          console.log("steam id undefined");

        }else{
          document.getElementById("game-install").getElementsByClassName("modal-button-big-container")[0].innerHTML +=`<div class="modal-button-big "   id="install-game-steam-button" >

            <!--<i class="fas fa-game-console-handheld"></i>--><i class="fab fa-steam"></i>Install With Steam
          </div>
          `;
          var protonDBrating = Math.round(protonGame(steamID)["compatibility"]*100);
          document.getElementById("modal").className = "";
          if(protonDBrating < 10){
              document.getElementById("game-install").getElementsByClassName("modal-button-big-container")[0].innerHTML += "<p> Warning: Less than 10% of users report that this game works on Proton</p> ";
          }else{
            document.getElementById("game-install").getElementsByClassName("modal-button-big-container")[0].innerHTML += "<p >" + protonDBrating + "% of users report that this game works with Proton</p> ";

          }
          document.getElementById("game-install").getElementsByClassName("modal-button-big-container")[0].innerHTML += "<p onClick='openUrlInBrowser(`https://www.protondb.com/app/" + steamID + "`)'><a href='#'>Full Proton installation instructions <i class='fas fa-external-link-alt'></i></a></p> ";
          document.getElementById("install-game-steam-button").setAttribute("onClick" , "installSteamGame(" + steamID + ");");

        }

        if(game["platforms"].includes("steam")){

        }else{
          try{
            document.getElementById("install-game-steam-button").remove();

          }catch{

          }
        }



        document.getElementById("game-install").getElementsByClassName("modal-button-big-container")[0].innerHTML +=`<div class="modal-button-big "  id="install-game-lutris-button">
          <i class="fas fa-cloud-download-alt"></i>Install with Lutris
        </div>`;

        var lutrisSlug = (await DBgameSLG(slug))["lutrisSlug"];
        var lutrisInstallable = (await DBgameSLG(slug))["lutrisInstallable"];
        document.getElementById("install-game-lutris-button").setAttribute("onClick" , "installLutrisGame('" + lutrisSlug + "');");






        if(typeof (lutrisSlug) == "undefined" || !lutrisInstallable){
          console.log("lutris slug undefined");
          document.getElementById("install-game-lutris-button").remove();
            document.getElementById("game-install").getElementsByClassName("modal-button-big-container")[0].innerHTML +=`<div class="modal-button-big "  id="install-game-lutris-button">
            <i class="fas fa-cloud-download-alt"></i>Install with Lutris*
          </div>
          <p>No Lutris Installer was found on the database</p>
          `;
          document.getElementById("install-game-lutris-button").setAttribute("onClick" , "installLutrisGame(" + slug + ");");
        }

        document.getElementById("game-install").getElementsByClassName("modal-button-big-container")[0].innerHTML += `<div class="modal-button-big " id="install-game-custom-button" onClick="">
          <i class="fas fa-terminal"></i>Add as a custom game
        </div>`

      }

      function uninstallGame(slug){

      }
      function uninstallSteamGame(steamID){
        ipcRenderer.send('uninstallSteamGame', steamID);
      }
      function openLutris(){
        ipcRenderer.send('openLutris');
      }
      async function openSteamCommunityPage(steamID, checkExistsOnly= false){

          var html = await getPageSourceHTML("https://steamcommunity.com/app/" + steamID);


          if(typeof(html.getElementsByClassName("apphub_CardContentMain")[0])  !== "undefined"){
            if(checkExistsOnly){
              return true;
            }else{

              ipcRenderer.send('openSteamCommunityPage', steamID);

            }
          }else{
            return false;
          }


      }
      function backupSteamGame(steamID){
        ipcRenderer.send('backupSteamGame', steamID);

      }
      function viewSteamStorePage(steamID){
          ipcRenderer.send('viewSteamStorePage', steamID);
      }

      function installSteamGame(steamID){
        ipcRenderer.send('installSteamGame', steamID);
      }
      function installLutrisGame(id){
        ipcRenderer.send('installLutrisGame', id);
      }

      function viewSteamGameScreenshots(steamID){
        ipcRenderer.send('viewSteamGameScreenshots', steamID);

      }

      function launchGame(slug){
        var d = new Date();
        var lastPlayed = d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
        usergames[usergamesSLG(slug, true)]["last-played"] = lastPlayed;
        updateUserGames();
          if(usergamesSLG(slug)["installed"] == true){
            if(usergamesSLG(slug)["installed-platforms"].includes("steam")){
              launchSteamGame(usergamesSLG(slug)["steamid"])
            }else if(usergamesSLG(slug)["installed-platforms"].includes("lutris")){
              launchLutrisGame(usergamesSLG(slug)["lutris-slug"]);
            }
          }
          document.getElementById("game").setAttribute("scrolled-down", "true");
          document.getElementsByClassName("game-logo")[0].getElementsByTagName("img")[0].className="loading-game-logo";
      }



async function fetchGameAchievements(id){
  var achievements = [];
  var x = await fetch('https://steamcommunity.com/id/' + steamuserid + '/stats/' + steamApps[id]["steamid"]);
  var y = await x.text();
  var doc = new DOMParser().parseFromString(String(y), "text/html");
  console.log("working on " + steamApps[id]["name"]);
  x= 0
  while(x < doc.getElementsByClassName("achieveRow").length){

      var achievementName = doc.getElementsByClassName("achieveRow")[x].getElementsByTagName("h3")[0].innerHTML;
      var achievementDescription = doc.getElementsByClassName("achieveRow")[x].getElementsByTagName("h5")[0].innerHTML;
      try{
      var achievementImage = doc.getElementsByClassName("achieveRow")[x].getElementsByTagName("img")[0].src;
      }catch(e){
        console.log("no image");
        var achievementImage = "no-image";
      }
      var achievementUnlocked = "true";
      try{
      var achievementUnlockTimeRaw = doc.getElementsByClassName("achieveRow")[x].getElementsByClassName("achieveUnlockTime")[0].innerHTML;
      var achievementUnlockTime = parseSteamAchievementDate(achievementUnlockTimeRaw);
      }catch(e){
        var achievementUnlocked = "false";
        var achievementUnlockTimeRaw = "not-unlocked";
        var achievementUnlockTime = null;
      }
      var achievement = {"achievementName": achievementName, "achievementDescription": achievementDescription, "achievementImage": achievementImage, "achievementUnlockTimeRaw" : achievementUnlockTimeRaw,  "achievementUnlockTime" :  achievementUnlockTime, "achievementUnlocked" : achievementUnlocked};

    if(achievements.includes(achievement)){
      console.log("duplicate");

    }else{
      achievements.push(achievement);
    }
    x++
  }
  console.log(achievements);
  steamApps[id]["achievements-steam"] = achievements;
}



  var steamDone = false;
  async function getSteamAchievements(){
        var i = 0;



        while(i < steamApps.length){
            fetchGameAchievements(i);
          i++;
        }
        steamDone = true;
        combineArrays();
      }

      //function addLibraryCard(id){
      //  if (steamApps[id]["type"] === "game"){
      //    document.getElementById("library").innerHTML += '<div class="game-lib-icon" onClick = "launchSteamGame(' + usergames[id]["steamid"] + ')" style="background-image:url(' + usergames[id]["assets"]["box"] + ')"></div>';
      //
      //  }else{
      //    console.log("url_does_not_exist");
      //  }
      //}

      //function populateLibrary(){
      //  x = 0;
      //  while (x < usergames.length){
      //    addLibraryCard(x);
      //    x++;
      //  }
      //}

      async function fetchSteamBadges(){

        var p = 0;

        while(p<steamApps.length){
          fetchGameBadgesSteam(p);
          p++;
        }
      }


      async function fetchGameBadgesSteam(steamAppsID){
        var badges = [];


        var steamid = steamApps[steamAppsID]["steamid"]
        var x = await fetch('https://steamcommunity.com/id/' + steamuserid  + '/gamecards/' + steamid);
        var y = await x.text();
        var doc = new DOMParser().parseFromString(String(y), "text/html");
        x= 0
        console.log( doc.getElementsByClassName("badge_card_set_card"));
        while(x < doc.getElementsByClassName("badge_card_set_card").length){

          var badgeName = doc.getElementsByClassName("badge_card_set_card")[x].getElementsByClassName("badge_card_set_text")[0].innerHTML.replace(/<\/?[^>]+(>|$)/g, "").replace(/\s+/g, ' ').trim();

          var badgeImage = doc.getElementsByClassName("badge_card_set_card")[x].getElementsByTagName("img")[0].src;
          if(badgeName.includes("(")){
            var badgeName = badgeName.replace("(" + gitBetween(badgeName, "(", ")") + ")", "").trim();
            var badge = {badgeName, badgeImage};
            badges.push(badge);
          }
          x++
        }
        console.log(badges);
        steamApps[steamAppsID]["badges-steam"] = badges;
      }

      async function fetchSteamWishlist(){
        var x = await fetch('https://store.steampowered.com/wishlist/id/' + steamuserid);
        var y = await x.text();
        var doc = new DOMParser().parseFromString(String(y), "text/html");
        var steamWishlistRaw = JSON.parse(gitBetween(doc.body.innerHTML, "var g_rgWishlistData = ", ";"));
        console.log(steamWishlistRaw);
        var w =0;

        while(w<steamWishlistRaw.length){
          var steamid = await steamWishlistRaw[w]["appid"];
          console.log(steamid);
          var e = 0;

          while(e<database.length){
            if(await getDatabaseValue(e, "steamID") == steamid){
              console.log("found");
              var slug = await getDatabaseValue(e, "slug");
              if(!userinfo["wishlist"].includes(slug)){
                await userinfo["wishlist"].push(slug.replaceAll("_", "-"));
              }
            }else{
              //console.log("not found");
            }
            await e++;
          }
          w++;
        }
      }
    </script>




    <script>
    var imageDatabase = [];
    async function importImageDatabase(){
      imageDatabase = await JSON.parse(await readfile("resources/app/data/files/files.json"));

    }

    /*THIS IS A FUCKING MASSIVE SECURITY RISK. Put it  in the bloody index.js*/
    /*https://stackoverflow.com/questions/11944932/how-to-download-a-file-with-node-js-without-using-third-party-libraries*/
    const https = require('https'); // or 'https' for https:// URLs




      function produceImageUrl(url){

        if(url.length>1 && (url.includes("//"))){
          name = require("crypto").randomBytes(64).toString('hex');
          var fileExtension = url.split('.').pop().replaceAll("?" + gitBetween( url.split('.').pop() + "****", "?", "****"), "");
          if(url.includes("epicgames.com/salesEvent")){
            var fileExtension = "jpg";
          }
          if(fileExtension.includes("net") || fileExtension.includes("com") || fileExtension.includes("http") || fileExtension.includes("uk") || fileExtension.includes("ie") || fileExtension.includes("eu")){
              var fileExtension = "jpg";
          }
            fileName = name + "." + fileExtension;

          if(typeof imageDatabase[url]  == "undefined"){
            if(fileExtension == "jpg" || fileExtension == "png" || fileExtension == "webm" || fileExtension == "jpeg"){
              ipcRenderer.send('produceImageUrl', url, fileName);
              importImageDatabase();
            }

            return("data/files/" + fileName);
          }else{
            return("data/files/" + imageDatabase[url]);
          }
        }else{
          return "";
        }


      }

      function refreshBackgroundImages(){
        //console.log("refreshing-background images");
        var allElements = document.getElementsByTagName("*");

        var x = 0;

        while(x<allElements.length){
          try{
            if(allElements[x].getAttribute("style").includes("url('data/files/")){
              var backgroundImageStyle = allElements[x].getAttribute("style");
              allElements[x].setAttribute("style", "");

              allElements[x].setAttribute("style", backgroundImageStyle);
            }
          }catch{

          }

          try{
            if(allElements[x].getAttribute("src").includes("data/files/")){
              var backgroundImageStyle = allElements[x].getAttribute("src");
              allElements[x].setAttribute("src", "");

              allElements[x].setAttribute("src", backgroundImageStyle);
            }
          }catch{

          }
          x++;
        }

      }





      async function downloadUsergamesImages(){
        var x =0;

        while (x<usergames.length){
          //console.log(x);

          try{produceImageUrl(usergames[x]["assets"]["header"]);}catch{};
          try{produceImageUrl(usergames[x]["assets"]["box"]);}catch{};
          try{produceImageUrl(usergames[x]["assets"]["hero"]);}catch{};
          try{produceImageUrl(usergames[x]["assets"]["logo"]);}catch{};
          try{produceImageUrl(usergames[x]["assets"]["background"]);}catch{};
          try{produceImageUrl(usergames[x]["assets"][0]);}catch{};

          try{
            var game = await DBgameSLG(usergames[x]["slug"]);
            try{produceImageUrl(game["assets"]["header"])}catch{};
            try{produceImageUrl(game["assets"]["box"])}catch{};
            try{produceImageUrl(game["assets"]["hero"])}catch{};
            try{produceImageUrl(game["assets"]["logo"])}catch{};
            try{produceImageUrl(game["assets"]["screenshots"][0])}catch{};
          }catch{

          }


          try{
            var y = 0;
            while(y<usergames[x]["badges-steam"].length){
              produceImageUrl(usergames[x]["badges-steam"][y]["badgeImage"]);
              y++;
            }
          }catch{

          }

          try{
            var y = 0;
            while(y<usergames[x]["badges-uplay"].length){
              produceImageUrl(usergames[x]["badges-uplay"][y]["badgeImage"]);
              y++;
            }
          }catch{

          }

          try{
            var y = 0;
              while(y<usergames[x]["achievements-steam"].length){
                produceImageUrl(usergames[x]["achievements-steam"][y]["achievementImage"]);
                y++;
            }
          }catch{

          }
          try{
            var y = 0;
            while(y<usergames[x]["achievements-gog"].length){
              produceImageUrl(usergames[x]["achievements-gog"][y]["achievementImage"]);
              y++;
            }
          }catch{

          }
          try{
            var y = 0;
            while(y<usergames[x]["achievements-origin"].length){
              produceImageUrl(usergames[x]["achievements-origin"][y]["achievementImage"]);
              y++;
            }
          }
          catch{

          }
          x++;
        }
      }
    </script>





<!--
    <div class="alert">
      <div class="title">Sync Steam Profile</div>
      <div class="logo"></div>
      <div class="disclaimer">Please enter your profile ID. Note that your profile needs to be set to Public.<!-- For more information click here--><!--</div>
      <div class="input"><input type="text" id="profile-name" name="profile-name"></div>
      <div class="buttons"><button type="button" id="continue" name="continue" onClick="fetchSteamProfile(document.getElementById('profile-name').value)">Continue</button></div>
    </div>


<div class="ProfileOutputData">
  <code id ="raw">
    </code>
    <ul id="steamInfo">
    <li>Your Steam ID: <span id="ID">UNKNOWN</span></li>
    <li>Your Steam Name: <span id="username">UNKNOWN</span></li>
    <li>Your Human Name: <span id="name">UNKNOWN</span></li>
  </ul>
</div>
<div id = "library">
</div>
-->
<style>
  .game-lib-icon{
    width:300px;
    height:450px;
    display:inline-block;
  }
</style>



    <script>

    //get date; useful for storing database

    function getCurrentDate(){
      var d = new Date();
      return d.getFullYear() + "-" + (d.getMonth()+1) + "-" + d.getDate();
    }


      //database related functions
      async function getPageSourceHTML(url){
        var x = await fetch(url);
        var y = await x.text();
        var doc = new DOMParser().parseFromString(String(y), "text/html");
        return doc
      }
      async function getPage(url){
        var x = await fetch(url, {
          headers: {
            'Cache-Control': 'no-cache'
          }
        });
        var y = await x.text();
        return y;
      }
      function makeHTML(text){
        var doc = new DOMParser().parseFromString(String(text), "text/html");
        return doc
      }

      var databaseImported = false;
      var databaseImportedPart = false;
      var database = [];
      var databaseAddress = "https://ull.pmurphy.dev/database/latest.json";
      var protonDB = []
      async function importProtonDB(){
        protonDB = JSON.parse(await getPage("https://ull.pmurphy.dev/database/protondb.json"));
      }
      function protonGame(steamID, getGameKey = false){

        x=0;
        var gameKey = "not found";
        while(x<protonDB.length){
          if(protonDB[x]["steamID"] === steamID){
            gameKey = x;
          }
          x++;
        }
        if(gameKey === "not found"){
        //  console.log("game '" + steamID + "' not in allApps")
            return("not found");

        }else{
          if(getGameKey){
            return gameKey;
          }else{
            return protonDB[gameKey];
          }
        }
      }
      var databaseImporting = false;
      async function importDatabase(){

        try{
          database = JSON.parse(await readfile("database/latest.json"));
          console.log("database from file loaded");
        }catch{
          console.log("no local database was present");
        }

        try{
          if(!databaseImporting){
            databaseImporting = true;
            database = JSON.parse(await getPage(databaseAddress));
            console.log("database imported");
            databaseImported = true;
            writeFile("database/" + await getCurrentDate() + ".json", await JSON.stringify(database, null, 2));
            writeFile("database/latest.json", await JSON.stringify(database, null, 2));
          }

        }catch{
          console.log("failed to download database. Make sure you have a functioning internet connection");
        }

      }
      async function importDatabaseLocal(){

        try{
          database = JSON.parse(await readfile("database/latest.json"));
          console.log("database from file loaded");
          databaseImported = true;
        }catch{
          console.log("no local database was present");
        }
      }



      async function getDatabaseValue(l1, l2 = null, l3 = null){
        if(!databaseImported){
          await importDatabase();
        }

        if(l2 ===null){
          return database[l1];
        }else if(l3 ===null){
          return database[l1][l2];
        }else{
          return database[l1][l2][l3];
        }
      }

      async function DBgameSLG(slug){
        if(!databaseImported){
          await importDatabase();
        }
        x=0;
        var gameKey = "not found";
        while(x<database.length){
          if(await getDatabaseValue(x, "slug") === slug){
            gameKey = x;
          }
          x++;
        }
        if(gameKey === "not found"){
          console.log("game '" + slug + "' not in database")

          if(slug.includes("standard-edition")){
            return DBgameSLG(slug.replaceAll("-standard-edition", "").replaceAll("standard-edition", ""));
          }else{
            return("not found");
          }

        }else{
          return database[gameKey];
        }
      }






      function DBgameLutrisSLG(lutrisSlug, getGameKey = false){
        x=0;
        var gameKey = "not found";
        while(x<database.length){
          if(database[x]["lutrisSlug"] === lutrisSlug){
            gameKey = x;
          }
          x++;
        }
        if(gameKey === "not found"){
        //  console.log("game '" + steamID + "' not in database")
            return("not found");

        }else{
          if(getGameKey){
            return gameKey;
          }else{
            return database[gameKey];
          }
        }
      }

      function DBgameSTEAMID(steamID, getGameKey = false){
        x=0;
        var gameKey = "not found";
        while(x<database.length){
          if(database[x]["steamID"] === steamID){
            gameKey = x;
          }
          x++;
        }
        if(gameKey === "not found"){
        //  console.log("game '" + steamID + "' not in database")
            return("not found");

        }else{
          if(getGameKey){
            return gameKey;
          }else{
            return database[gameKey];
          }
        }
      }

      function usergamesSTEAMID(steamID, getGameKey = false){
        var x=0;
        var gameKey = "not found";
        while(x<usergames.length){
          if(usergames[x]["steamid"] == steamID){
            gameKey = x;
          }
          x++;
        }
        if(gameKey === "not found"){
        //  console.log("game '" + steamID + "' not in database")
            return("not found");

        }else{
          if(getGameKey){
            return gameKey;
          }else{
            return usergames[gameKey];
          }
        }
      }


      function usergamesSLG(slug, getGameKey = false){
        x=0;
        var gameKey = "not found";
        while(x<usergames.length){
          if(usergames[x]["slug"] === slug){
            gameKey = x;
          }
          x++;
        }
        if(gameKey === "not found"){
        //  console.log("game '" + steamID + "' not in database")
            return("not found");

        }else{
          if(getGameKey){
            return gameKey;
          }else{
            return usergames[gameKey];
          }
        }
      }


      function DBgameGOGID(gogID, getGameKey = false){

        x=0;
        var gameKey = "not found";
        while(x<database.length){
          if(database[x]["gogID"] === gogID){
            gameKey = x;
          }
          x++;
        }
        if(gameKey === "not found"){
        //  console.log("game '" + steamID + "' not in database")
            return("not found");

        }else{
          if(getGameKey){
            return gameKey;
          }else{
            return database[gameKey];
          }
        }
      }





    </script>
    <div id="main">
      <div id="syncing-notice">
        Syncing your library...
      </div>
      <div id="login-modal">
        <div id="database-import-load-screen">
          <div class="loading full-width" id="database-loading">
            <i class="fas fa-spinner"></i>
          </div>
          <div class="title-small">
            Syncing...
          </div>
          <div class="info block">
            Downloading game database. This should take less than a minute.
          </div>
        </div>

        <div id="steam-login">
          <div class="title-small">Sync Steam Library</div>
          <form id="steam-form">
            <div class = "info block">
              Your Steam Profile, including Game details, needs to be set to Public. Your data will be kept locally on your system. For more details on how this works, click <a>here</a>
            </div>
            <input id="steam-username" type = "text" onKeyDown="showSteamUserName();" onmouseout="showSteamUserName();"></input>
            <button type="button" onClick="syncSteam(document.getElementById('steam-username').value)">Login</button>
          </form>
          <div class = "info block">
            Your username <div class="blob-highlight inline-block" id="steam-name"></div>
          </div>
          <div class = "info block">
            Your "human" name <div class="blob-highlight inline-block" id="steam-human-name"></div>
          </div>
        </div>


        <div id="steam-login-done">
            <div class="loading full-width" id="steam-loading">
              <i class="fas fa-spinner"></i>
            </div>

            <div id="add-more-stores">
              <div class="title-small">Sync Steam Library</div>
              <div class="info block">
                We are currently syncing your Steam Achievements in the background. While you wait, would you like to add some more platforms?
              </div>
              <button type="button" onClick="addGog()">GOG</button>
            </div>
        </div>

        <div id="add-gog">
          <div class="title-small">Add GOG</div>
          <div id="gog-sign-in">
            <div class="info">We're now going to sign into your GOG account. For full details on how this works click <a>here</a>. Note that your profile needs to be public for this to work.</div>

              <input id="gog-username" type= "text"></input>
              <button type="button" onClick="gogSignIn(document.getElementById('gog-username').value);">Continue</button>

            <div class="crawler-container" id="gog-crawler-container">
              <hr>
              <iframe id="gog-crawler" src = "" style="width:1920px; height:1080px; overflow:hidden;"></iframe>
            </div>
          </div>
          <div id="gog-loading">
            <div class="loading full-width">
              <i class="fas fa-spinner"></i>
            </div>
            <div class="info">
              Syncing...
            </div>
          </div>
          <div id="gog-complete">
            <hr>
            <div class="info">We've finished syncing your GOG library. Your achievements will sync in the background. Would you like to add some more platforms?</div>
            <button type="button" onClick="addOrigin()">Origin</button>
          </div>
        </div>


        <div id="add-origin">
          <div class="title-small">Add Origin</div>
          <div id="origin-confirmation">
            <div class="info">
              We're now going to sign into your Origin account. For full details on how this works click <a>here</a>. Note that your Login details will not be stored.
            </div>
            <button type="button" onClick="originSignIn()">Continue</button>
          </div>
          <div id="origin-crawler-container">
            <iframe id="origin-crawler" name="google-disable-x-frame-options"  src="" style="width:1920px; height:1080px; overflow:hidden;"></iframe>
          </div>
          <div id="origin-games-sync-prompt">
            <div class="info">
              Please enter your username and password in the login modal. Click continue when you are done.

            </div>
            <button type="button" onClick="originSyncGames()">Continue</button>
          </div>

          <div id="origin-loading">
            <div class="loading full-width">
              <i class="fas fa-spinner"></i>
            </div>
            <div class="info">
              Hold tight, we are now syncing your library.
            </div>
          </div>

          <div id="origin-done">

            <div class="info">
              We've now imported your Origin Library and Achievements. Would you like to add another store/launcher?
            </div>
            <button type="button" onClick="addUplay()">Ubisoft Connect</button>
          </div>

        </div>

        <div id="add-uplay">
          <div class="title-small">Add Uplay</div>
          <div id="uplay-confirmation">
            <div class="info">
              We're now going to sign into your Ubisoft Connect account. For full details on how this works click <a>here</a>. Note that your Login details will not be stored.
            </div>
            <button onClick="uplaySignIn()">Continue</button>
          </div>
          <div id="uplay-loading">
            <div class="loading full-width">
              <i class="fas fa-spinner"></i>
            </div>
            <div class="info">
              Hold tight, we are now syncing your library.
            </div>
          </div>

          <div id="uplay-crawler-container">
            <iframe id="uplay-crawler" ></iframe>
          </div>

          <div id="uplay-done">
            <div class="info">
              We've now imported your Ubisoft Connect Library. Would you like to add another store/launcher?
            </div>
            <button type="button" onClick="addEpic()">Epic Games</button>
          </div>
        </div>
        <div id="add-epic">
          <div class="title-small">Add Epic Games</div>
          <div id="epic-confirmation">
            <div class="info">
              We're now going to sync your Epic Games account. For full details on how this works click <a>here</a>. Note that your Login details will not be stored.
            </div>
            <button onClick="epicSignIn()">Continue</button>
          </div>

          <div id="epic-loading">
            <div class="loading full-width">
              <i class="fas fa-spinner"></i>
            </div>
            <div class="info">
              Hold tight, we are now syncing your library.
            </div>
          </div>

          <div id="epic-crawler-container">
            <iframe src="" id="epic-crawler" style="width:1920px;height:1080px;"></iframe>
          </div>

          <div id="epic-done">
            <div class="info">
              We've now imported your Epic Games library. Would you like to add another store/launcher?
            </div>
            <button type="button" onClick="finishSync()">I'm done</button>
          </div>
        </div>

        <div id="finishing-crawl">
          <div class="title-small">Finishing off Sync</div>
          <div id="finishing-loading">
            <div class="loading full-width">
              <i class="fas fa-spinner"></i>
            </div>
          </div>
          <div class="info">
            We're just indexing the last few achievements from earlier. Keep climbing that synchronisation tower.
          </div>
        </div>

        <div id="crawl-finished">
          <div class="title-small">Ready</div>
          <div class="info">
            We've indexed all your games and achievements
          </div>
          <button type="button" onClick="loadApp()">Let's go!</button>
        </div>
      </div>
      <div id="app">
        <div id="sidebar">
          <img id="logo" src = "assets/logo-green-transparent.png">
          <hr>
          <div id="sidebar-buttons">
            <i class="fas fa-plus" onClick="openPlusMenu()"></i><i class="fas fa-cog"></i><i onclick="showElement('search-box');searchBoxActive  = true;document.getElementById('search-text').innerHTML = '';document.getElementById('search-results').innerHTML = '';"class="fas fa-search"></i>
          </div>
          <div id="sidebar-links">
            <h3 class="sidebar-header">Library</h3>
            <ul class="sidebar-row" id="sidebar-library">
              <li onclick="loadLibrarySection('all')">Owned</li>
              <li onclick="loadLibrarySection('installed')">Installed</li>
            </ul>
            <h3 class="sidebar-header">Store</h3>
            <ul class="sidebar-row" id="sidebar-store">
              <li onclick="loadStoreSection('wishlist')">Wishlist</li>
            </ul>
          </div>
        </div>
        <div id="content-header">
          <div class="title-main">bigfatdino<span class="gelasio">/</span><span id="current-page">library</span><span class="gelasio">/</span><span id = "current-section" class="opensans-light">all-games</span></div>
        </div>
        <div id="content">
          <div id="recent-activity">

          </div>
          <div id="library">

          </div>


          <script>

          var mouseX = 0;
          var mouseY = 0;
          document.getElementById("content").onscroll = function(e) {
              if(document.getElementById("content").scrollTop) {
                  if(document.getElementById("content").scrollTop > 10) {
                    document.getElementById("game").setAttribute("scrolled-down", "true");
                    //document.getElementById("game").id = "game scrolled-down";
              //        document.getElementById("game").height = "100px";
                  } else {
                  //    document.getElementById("game").id = "game";
                  document.getElementById("game").setAttribute("scrolled-down", "false");
                  }
              }
            }

            function mouseOutsidePage(){
              if(mouseX <=0 || mouseY <= 0 || mouseX >= window.innerWidth || mouseY >= window.innerHeight){
                return true;
              }else{
                return false;
              }
            }

            function moveGameBadge(x){
                var y = 0;


                while(y<document.getElementsByClassName("badge").length){
                  if(y!== x){
                    document.getElementsByClassName("badge")[y].style = "visibility: hidden; height:0; width:0; overflow:hidden;";

                  }
                  y++;
                }

              if(mouseOutsidePage()){
                stopBadgeMove(x);
              }else{
                  document.getElementsByClassName("badge")[x].style="left:" + (mouseX - 270) + ";top:" + (mouseY - 240) +  ";position: fixed;";
              }

            }

            var moveBadgeTimer

            var activeBadge;
            function activateBadgeMove(x){

              stopBadgeMove(x);
              activeBadge = x;
              document.getElementsByClassName("badge")[x].id="moving";
              moveBadgeTimer = setInterval(function() {

                moveGameBadge(activeBadge);
              }, 1)
            }

            function stopBadgeMove(x){
              clearInterval(moveBadgeTimer);
              document.getElementsByClassName("badge")[x].style="";
              document.getElementsByClassName("badge")[x].id="";
              var y = 0;
              while(y<document.getElementsByClassName("badge").length){
                  document.getElementsByClassName("badge")[y].style = "";
                y++;
              }
            }

            var dataslipTimer;
            var activeBadge;
           function activateBadgeDataslip(x){

               activeBadge = x;
               dataslipTimer = setInterval(function() {
                  try{
                     document.getElementsByClassName("badge-hover-text")[x].style="left:" + (mouseX +  20) + ";top:" + (mouseY + 20) +  ";position: fixed;";
                   }catch{

                   }
               }, 5);


            }

            function deactivateBadgeDataslip(x){
              document.getElementsByClassName("badge-hover-text")[x].style="";
              clearInterval(dataslipTimer);

            }
            function deactivateBadgeDataslips(){
              var x = 0;
              while(x<document.getElementsByClassName("badge-hover-text").length){
                document.getElementsByClassName("badge-hover-text")[x].style="";
                clearInterval(dataslipTimer);
                x++;
              }


            }

            achievementInfoTimer = setInterval(function() {
              var x = 0;
              while(x < document.getElementsByClassName("achievement-onclick-description").length){
                  document.getElementsByClassName("achievement-onclick-description")[x].style="left:" + (mouseX +  20) + ";top:" + (mouseY + 20) +  ";position: fixed;";
                x++;
              }


            }, 5);
          </script>



          <!-- Scroll animation Starts off as 40% of screen, then squashes down to about 200px which is the height of the logo. -->
          <div id="game">

          </div>
          <div id="store">
            <div id="wishlist">

            </div>
          </div>


        </div>
      </div>
      <div id="search-box" >
        <div id="modal-header"><span>Search</span> <span class="modal-button" onClick="hideElement('search-box');searchBoxActive = false;"><i class="fas fa-times-circle"></i></span></div>


        <div id="search-text">

        </div>

        <div id="search-results">
          <div class="search-result">
            <div class="search-result-header">

            </div>
            <div class="search-result-contents">
              <div class="search-result-title">
                Type to see more results.
              </div>
              <div class="search-result-further-info">
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
      <div id="wishlist-notification" >
        <div id="wishlist-notification-top-bar"><span id="wishlist-header">WISHLIST</span><span class ="modal-button" id="close-wishlist-notification" onclick = "hideElement('wishlist-notification'); modalActive = false;"><i class="fas fa-times-circle"></i></span></div>

        <div id="wishlist-notification-content-headers">
          <div class="wishlist-notification-content-header" style="background-image: url('data/files/7d4d9ef9c24fde0191ab37e1cea737f557c4b8d7ed4c44d759759a086df2acdd9b496888b12ff764bc364eca8cc1a0b5e72ec38fde6b15b5a71775895326cde4.jpg')">

          </div>
        </div>
        <div id="wishlist-notification-content">

          <div id="wishlist-notification-content-text">
            ERROR!!!!!!
          </div>
        </div>
        <div id="wishlist-notification-action-buttons">
          <span class="wishlist-notification-action-button" onclick="loadStoreSection('wishlist', 'onSaleOnly')">
            View
          </span>
        </div>
      </div>
      <div id="modal" class="mini">
        <div id="modal-header"><span id="modal-header-content">Add product or category</span> <span class="modal-button" onClick="hideElement('modal'); modalActive = false;"><i class="fas fa-times-circle"></i></span></div>

          <div id="game-install">
            <div class="modal-content" id="add-game">
              Please select a platform to install the game from
              <div class="modal-button-big-container">
                <div class="modal-button-big "   id="install-game-steam-button" >

                  <!--<i class="fas fa-game-console-handheld"></i>--><i class="fab fa-steam"></i>Install With Steam
                </div>
                <div class="modal-button-big "  id="install-game-lutris-button">
                  <i class="fas fa-cloud-download-alt"></i>Install with Lutris
                </div>
                <div class="modal-button-big " id="install-game-custom-button" onClick="">
                  <i class="fas fa-terminal"></i>Add as a custom game
                </div>
              </div>
            </div>
          </div>

          <div class="modal-content" id="plus-menu">
            Would you like to add a custom product?
            <div class="modal-button-big-container">
              <div class="modal-button-big " onClick="addCustomGame();">

                <!--<i class="fas fa-game-console-handheld"></i>--><i class="fas fa-gamepad"></i>Add a custom game
              </div>
              <div class="modal-button-big " onClick="        openModal('add-category');hideElement('automatic-details');hideElement('manual-details');document.getElementById('modal-header-content').innerHTML = 'Add category';        updateGamesListInModal();">
                <i class="fas fa-plus-square"></i>Add a category
              </div>
              <div class="modal-button-big " onClick="openModal('activate-product');">
                <i class="fas fa-shopping-bag"></i>Activate a product
              </div>
            </div>
          </div>


          <div class="modal-content" id="activate-product">
            Please select a store to activate the product on.
            <div class="modal-button-big-container">
              <div class="modal-button-big " onClick="activateGameSteam();">
                <i class="fab fa-steam"></i>Steam
              </div>
              <div class="modal-button-big " onClick="activateGameGOG();">

                <i class="fas fa-globe-europe"></i>GOG
              </div>

              <div class="modal-button-big " onClick="activateGameEpic();">
                <i class="fas fa-globe-americas"></i>Epic Games
              </div>
            </div>
          </div>


          <div class="modal-content" id="add-category">
            Type of category
            <form>
              <input type="radio" id="auto" name="type" value="auto" onClick="hideElement('manual-details'); showElement('automatic-details');document.getElementById('modal').className = 'mini';createCategoryType='automatic';">
              <label for="auto">Automatic </label><br>
              <input type="radio" id="custom" name="type" value="custom"  onClick="hideElement('automatic-details'); showElement('manual-details');document.getElementById('modal').className = 'normal';createCategoryType='manual';">
              <label for="custom">Custom</label><br>
            </form>
            <div class="pad">
              Category name
              <br>
              <input name="name" id="add-cat-name"></input>

            </div>
              <div id="automatic-details" class="pad">
                Category contents
                <form>
                  <select name="add-cat-view" id="add-cat-view">
                    <option value="all">All Games</option>
                    <option value="installed">Installed Games</option>
                    <option value="genre">Genre</option>
                    <option value="developer">Developer</option>
                    <option value="publisher">Publisher</option>
                    <option value="launcher">Launcher</option>
                  </select>
                  <input list="add-cat-extra-list" name="add-cat-extra" id="add-cat-extra">
                  <datalist id="add-cat-extra-list">

                  </datalist>
                </form>
              </div>


              <div id="manual-details" class="pad">
                Enter the names of the games you would like to add.
                <form id="gameNames_Container">
                  <div class="gameName-cover" id="gameName_0">
                  </div>
                  <datalist id="gameNames">

                  </datalist>

                  <div id="gameTags_input_container">

                  </div>
                </form>
              </div>

            <div class="modal-continue-button" onClick = "createCategoryFromModal()" >Continue</div>
          </div>

      </div>
    </div>


    <script>



    async function showSteamUserName(){

        setTimeout(async function(){
          try{
            profileName = document.getElementById("steam-username").value ;
            var x = await fetch('https://steamcommunity.com/id/' + profileName + '/');
            var y = await x.text();
            console.log(String(y));
            var doc = new DOMParser().parseFromString(String(y), "text/html");
            console.log(doc);
            console.log(doc.title);
            var username = doc.getElementsByClassName("actual_persona_name")[0].innerHTML;
            document.getElementById("steam-name").innerHTML = username;
            var name = doc.getElementsByClassName("header_real_name ellipsis")[0].getElementsByTagName("bdi")[0].innerHTML;
            document.getElementById("steam-human-name").innerHTML = name;
            console.log (name);
          }catch{
            document.getElementById("steam-name").innerHTML = "Profile not found";
            document.getElementById("steam-human-name").innerHTML = ";(";
          }
        },500);

    }
    var createCategoryType = null;

    function hideElement(id){
      document.getElementById(id).style.display = "none";
    }
    function showElement(id){
      document.getElementById(id).style.display = "unset";
    }




      var firstTime = true


      async function backgroundSync(){

        try{
          syncComplete=false;
          userinfo["config"]["synced-stores"] = [];
          showElement("syncing-notice");
          document.getElementById("syncing-notice").innerHTML = "Updating local games database...";
          backgroundSyncActive = true;
          importDatabase();
          await importUserData();
          await importUserGames();
          showElement("syncing-notice");
          await fetchInstalledGames();
          document.getElementById("syncing-notice").innerHTML = "Syncing your library...";

          hideElement("login-modal");
          await fetchSteamProfile(userinfo["logins"]["username-steam"]);
          await combineArrays();
          await gogSignIn(userinfo["logins"]["username-gog"]);
          showElement("syncing-notice");
        }catch{
          document.getElementById("syncing-notice").innerHTML = ":( Failed to sync";
        }


        window.setInterval(async function(){
          if(gogInitiated === true){
            if(gogDone & steamDone){
              if(userinfo["config"]["allowed-sync-platforms"].includes("origin") && !originDone){

              }else if(userinfo["config"]["allowed-sync-platforms"].includes("uplay") && !uplayComplete){

              }else if(userinfo["config"]["allowed-sync-platforms"].includes("epic") && !epicComplete){

              }else{
                if(syncComplete !== true){
                  userinfo["config"]["firstTime"] = "no";
                  await combineArrays();
                  await updateUserGames();
                  await updateUserData();

                  window.setTimeout(async function(){

                    hideElement("syncing-notice");
                    backgroundSyncActive = false;
                  },1500);

                  syncComplete=true;

                }else{

                }
              }

            }
          }
        }, 100);
      }





      async function sync(){
        modalActive = true;
        hideElement("app");
        showElement("login-modal");
        hideElement("add-origin");
        hideElement("wishlist-notification");
        hideElement("steam-login");
        hideElement("steam-login-done");
        hideElement("add-gog");
        hideElement("add-uplay");
        hideElement("add-epic");
        hideElement("finishing-crawl");
        hideElement("crawl-finished");
        showElement("database-import-load-screen");
        await importDatabase();
        await importUserData();
        try{
          await importUserGames();

        }catch{

        }
        userinfo["config"]["synced-stores"] = [];
        hideElement("database-import-load-screen");
        showElement("steam-login");
      }
      async function syncSteam(id){
        hideElement("steam-login");
        showElement("steam-login-done");
        hideElement("add-more-stores");
        await fetchSteamProfile(id);
        console.log("steamDone");
        hideElement("steam-loading");
        showElement("add-more-stores");
      }

      var gogInitiated = false;
      async function addGog(){
        hideElement("gog-complete");
        hideElement("add-more-stores");
        hideElement("steam-login-done");
        showElement("add-gog");
        hideElement("gog-crawler-container");
        hideElement("gog-loading");
      }

      var gogDone = false;
      var achievementGOGstarted = false;
      var gogGames = [];
      var q = 0;
      function gogSignIn(username){
        gogDone = false;
        userinfo["logins"]["username-gog"] = username;
        userinfo["config"]["synced-stores"].push("gog");
        showElement("gog-loading");
        var crawler = document.getElementById("gog-crawler");

        crawler.onload  = function(){
          waitForElement2("prof-game__title", "gog-crawler", function(){
            var page = document.getElementById("gog-crawler").contentWindow.document;
            console.log("crawler loaded");
            console.log(page.body.innerHTML);

            var gameCards = page.getElementsByClassName("games-matcher__row");
            console.log(gameCards);

            var z=0;

            while(z<gameCards.length){
              var name = gameCards[z].getElementsByTagName("h1")[0].innerHTML;
              //var hoursPlayed = gameCards[x].getElementsByTagName("span")[gameCards[x].getElementsByTagName("span").length-1].innerHTML;
              //if (hoursPlayed.includes("h")){
              //  var minutesPlayed = gitBetween("..." + hoursPlayed, "...", "h")*60 + gitBetween(hoursPlayed, "h", "m").replaceAll(/\D/g,'');
              //}else{
              //  var minutesPlayed = hoursPlayed.replaceAll(/\D/g,'');
              //}
              //console.log(hoursPlayed)
              //console.log(minutesPlayed);
              var slug = produceSlug(name);
              var achievementsUrl = gameCards[z].getElementsByTagName("a")[0].href;
              var gogID = achievementsUrl.replaceAll("/u/", "").replaceAll("username", "").replaceAll("/", "").replace(/[\W_]+/g,"").replace(/([a-zA-Z ])/g, "");
              var header = gitBetween(gameCards[z].getElementsByClassName("prof-game__image")[0].getAttribute("ng-srcset"), ", ", "2x").replaceAll("_prof_game_200x120", "");

              gogGames.push({name, slug, gogID, achievementsUrl, platforms: ["gog"], assets: [header]});
              console.log(name);
              z++;
            }
            console.log(gogGames);

            gogComplete();

            if(gogGames.length === 0){
              console.log("doing GOG add");
              setTimeout(function(){
                gogSignIn();
                return;
              },5000);
            }
            //user wishlist
            crawler.src= "https://www.gog.com/u/" + username + "/wishlist"



            crawler.onload  = function(){
              waitForElement2("product-title__text", "gog-crawler", function(){
                var page = document.getElementById("gog-crawler").contentWindow.document;
                var wishlistTags = page.getElementsByClassName("product-row-wrapper");

                var zp = 0;
                while(zp<wishlistTags.length){
                  var slug = produceSlug(wishlistTags[zp].getElementsByClassName("product-title__text")[0].innerHTML);
                  if(!userinfo["wishlist"].includes(slug)){
                    userinfo["wishlist"].push(slug);
                  }
                  zp++;
                }

                if(backgroundSyncActive){
                  var delay = 272;
                }else{
                  var delay = 100;
                }
                setInterval(async function() {
                  if(!crawlerBusy){
                    if(q<gogGames.length){
                      if(!gogDone){

                        gogInitiated = true;

                        q++;
                        var gogGameJSON = await getPage("https://api.gog.com/v2/games/" + gogGames[q]["gogID"]);
                        console.log("doing GOG achievements " +  q  + " / " + gogGames.length);

                        if(gogGameJSON.includes("achievements")){

                          gogGames[q]["achievements-gog"] = fetchGogAchievements(gogGames[q].achievementsUrl);

                        }else{
                          console.log("game does not have gog achievements");
                          gogGames[q]["achievements-gog"] = [];
                        }
                      }

                    }else{

                      if(achievementGOGstarted){
                        if(gogDone){

                        }else{
                          console.log("GOG Complete");
                          crawler.src = "";
                        //  gogComplete();
                          combineArrays();
                          if(backgroundSyncActive){
                            originSignIn(true);
                          }
                        }
                        gogDone=true;
                      }

                    }
                  }
                }, delay);
              });
            }
          });
        }
        document.getElementById("gog-crawler").src = "https://www.gog.com/u/" + username + "/games";
      }

      var achievements = [];
      var achievementTags = []
      var crawlerBusy = false;


      function fetchGogAchievements(url){
        achievementGOGstarted = true;
        crawlerBusy = true;
        console.log(url);
        //showElement("add-gog");
        hideElement("gog-crawler-container");
        achievements = [];
        var crawler = document.getElementById("gog-crawler");
        crawler.src = url;
          crawler.onload  =  function(){

            console.log("page loaded");
            var page =  document.getElementById("gog-crawler").contentWindow.document;
            var achievementTags =  page.getElementsByClassName("game-achievements-matcher__row-content--achievement");
            var y =0;
            while(y<achievementTags.length){
              var achievementName =  achievementTags[y].getElementsByClassName("prof-achievement__name")[0].innerHTML;
              var achievementDescription = achievementTags[y].getElementsByClassName("prof-achievement__description")[0].innerHTML;

              try{
                var achievementUnlockTimeRaw = achievementTags[y].getElementsByClassName("game-achievements-matcher__achievement-unlock-date")[0].innerHTML;
                var achievementUnlockTime = parseGOGAchievementDate(achievementUnlockTimeRaw);
                var achievementUnlocked = true;
              }catch{
                var achievementUnlockTimeRaw = null;
                var achievementUnlockTime = null;
                var achievementUnlocked = false;
              }

              var achievementRarity = achievementTags[y].getElementsByClassName("prof-achievement__rarity-percent")[0].innerHTML;
              var achievementImage = gitBetween("____" + achievementTags[y].getElementsByTagName("img")[0].getAttribute("srcset"), "____", " 1x").replace("_gac_60", "");

              var achievement = {achievementName, achievementDescription, achievementUnlockTimeRaw, achievementUnlockTime, achievementUnlocked, achievementRarity, achievementImage};
              achievements.push(achievement);
              y++;
            }
            crawlerBusy = false;
          console.log(achievements);

        }

        return achievements;
      }

      function gogComplete(){
        var crawler = document.getElementById("gog-crawler");
        crawler.src = "";
        //console.clear();

        hideElement("gog-sign-in");
        showElement("gog-complete");
        hideElement("gog-loading");

      }
      function combineArrays(){
        console.log("combining arrays");
        var found = false;
        x=0;
        while(x<steamApps.length){
          var slug = steamApps[x]["slug"];
          y=0;
          found = false;
          var allAppID;
          while(y<usergames.length & found === false){
            if(usergames[y]["slug"] === slug){
              allAppID = y;
              console.log(allAppID);
              console.log(slug);
              found= true;
            }
            y++;
          }
          if(found){
            console.log("duplicate game");
            if(Array.isArray(steamApps[x]["achievements-steam"])){
              usergames[allAppID]["achievements-steam"] = steamApps[x]["achievements-steam"];

            }
              usergames[allAppID]["badges-steam"] = steamApps[x]["badges-steam"];


            usergames[allAppID]["assets"] = steamApps[x]["assets"];
            usergames[allAppID]["name"] = steamApps[x]["name"];
            if(!usergames[allAppID]["platforms"].includes("steam")){
                usergames[allAppID]["platforms"].push("steam");
            }

          }else{
            usergames.push(steamApps[x]);
          }
          x++;
        }





        x=0;
        while(x<gogGames.length){
          var slug = gogGames[x]["slug"];
          y=0;
          found = false;
          var allAppID;
          while(y<usergames.length & found === false){
            if(usergames[y]["slug"] === slug){
              allAppID = y;
              console.log(allAppID);
              console.log(slug);
              found= true;
            }
            y++;
          }
          if(found){
            console.log("duplicate game");
            usergames[allAppID]["achievements-gog"] = gogGames[x]["achievements-gog"];
            usergames[allAppID]["name"] = gogGames[x]["name"];
            usergames[allAppID]["gogID"] = gogGames[x]["gogID"];
            if(!usergames[allAppID]["platforms"].includes("gog")){
              usergames[allAppID]["platforms"].push("gog");
            }
          }else{
            usergames.push(gogGames[x]);
            console.log(slug + "not duplicate");
          }
          x++;
        }



        x=0;
        while(x<originApps.length){
          var slug = originApps[x]["slug"];
          y=0;
          found = false;
          var allAppID;
          while(y<usergames.length & found === false){
            if(usergames[y]["slug"] === slug){
              allAppID = y;
              console.log(allAppID);
              console.log(slug);
              found= true;
            }
            y++;
          }
          if(found){
            console.log("duplicate game");
            usergames[allAppID]["achievements-origin"] = originApps[x]["achievements-origin"];
            usergames[allAppID]["name"] = originApps[x]["name"];
            if(!usergames[allAppID]["platforms"].includes("origin")){
                usergames[allAppID]["platforms"].push("origin");
            }

          }else{

            usergames.push(originApps[x]);
          }
          x++;
        }


        x=0;


        while(x<uplayGames.length){
          var slug = uplayGames[x]["slug"];
          y=0;
          found = false;
          var allAppID;
          while(y<usergames.length & found === false){
            if(usergames[y]["slug"] === slug){
              allAppID = y;
              console.log(allAppID);
              console.log(slug);
              found= true;
            }
            y++;
          }
          if(found){
            console.log("duplicate game");
            usergames[allAppID]["name"] = uplayGames[x]["name"];
            usergames[allAppID]["badges-uplay"] = uplayGames[x]["badges-uplay"];
            if(!usergames[allAppID]["platforms"].includes("uplay")){
              usergames[allAppID]["platforms"].push("uplay");
            }
          }else{
            usergames.push(uplayGames[x]);
          }
          x++;
        }

        x=0;

        while(x<epicGames.length){
          var slug = epicGames[x]["slug"];
          y=0;
          found = false;
          var allAppID;
          while(y<usergames.length & found === false){
            if(usergames[y]["slug"] === slug){
              allAppID = y;
              console.log(allAppID);
              console.log(slug);
              found= true;
            }
            y++;
          }
          if(found){
            console.log("duplicate game");
            usergames[allAppID]["name"] = epicGames[x]["name"];
            if(!usergames[allAppID]["platforms"].includes("epic")){
              usergames[allAppID]["platforms"].push("epic");
            }
          }else{
            usergames.push(epicGames[x]);
          }
          x++;
        }

        console.log(usergames);
      }





      function addOrigin(){
        hideElement("origin-done");
        hideElement("add-gog");
        showElement("add-origin");
        showElement("origin-confirmation");
        hideElement("origin-crawler-container");
        hideElement("origin-games-sync-prompt");
        hideElement("origin-loading");

      }



      function waitForElementToChange(elementId, callBack){
        if(firstRun){
           console.log("wiatin");
           pagee = document.getElementById("crawler").contentWindow.document;
           elemente = pagee.getElementsByClassName(elementId)[0];
           elementInnerhtmle = elemente.innerHTML;
          firstRun=false;
        }


        window.setTimeout(function(){


          var page2 = document.getElementById("crawler").contentWindow.document;

          if(page2.getElementsByClassName(elementId)[0].innerHTML == elementInnerhtmle){
            console.log("unchanged");
            waitForElementToChange(elementId, callBack);
          }else{
            console.log("changed");
            callBack(elementId, elemente);
            firstRun = true;
          }
        },100)
      }

      function waitForElement(elementId, callBack){
        var page = document.getElementById("origin-crawler").contentWindow.document;
        window.setTimeout(function(){
          var element = page.getElementsByClassName(elementId)[0];
          if(element){
            callBack(elementId, element);
          }else{
            waitForElement(elementId, callBack);
          }
        },500)
      }

      function produceSlug(name){

        var slug = name.trim().replaceAll(/[^\w\s]/gi, '').replaceAll(/\s+/g, ' ').replaceAll(" ", "-").toLowerCase();

        //let's manage some exceptions
        if(slug === "mass-effect-3"){
          var slug = "mass-effect-3-2012";
        }
        // should add some for the epic store tom clancys. Basicly designed to harmonise different slugs between different stores/ areas of stores.
        return slug;
      }
      var ranOnce = false;
      function originSignIn(backgroundCrawl = false){
        hideElement("origin-confirmation");
        var crawler = document.getElementById("origin-crawler");
        crawler.src = "https://www.origin.com/gbr/en-us/game-library";
        crawler.onload = function (){
          console.log("loaded");
          var page = document.getElementById("origin-crawler").contentWindow.document;
          console.log(page.body.innerHTML);
            waitForElement("otkbtn",function(){
              console.log("buttonloaded");
              page.getElementsByClassName('otkbtn')[2].click();
              originSyncGamesPrompt();
            });
            waitForElement("origin-gamelibrary-anonymous-actionitems",function(){
              if(backgroundCrawl){
                /*
                showElement("login-modal");
                showElement("add-origin");
                hideElement("steam-login");
                hideElement("add-gog");
                hideElement("add-uplay");
                hideElement("add-epic");
                hideElement("finishing-crawl");
                hideElement("crawl-finished");*/
              }


            });

            waitForElement("origin-gametile",function(){
              originSyncGames();
            });


        }
      }

      function originSyncGamesPrompt(){
        showElement("origin-games-sync-prompt");
        hideElement("origin-confirmation");
      }

      var originApps = [];
      var originDone =false;
      function originSyncGames(){
        originDone = false;
        userinfo["config"]["synced-stores"].push("origin");
        hideElement("origin-games-sync-prompt");
        showElement("origin-loading");
        var crawler = document.getElementById("origin-crawler");
        crawler.src = "https://www.origin.com/profile/games";

        crawler.onload = function (){
          waitForElement("origin-profile-games-gametile-scrim",function(){
            var page = document.getElementById("origin-crawler").contentWindow.document;
            console.log("loaded-user's-origin-games");
            var originUsername = page.getElementsByClassName("origin-profile-header-username")[0].innerHTML;
            var originGameTileTags = page.getElementsByTagName("origin-profile-page-games-gametile");

            var x = 0;
            while(x<originGameTileTags.length){
              var name = originGameTileTags[x].getAttribute("titlestr");
              var box = originGameTileTags[x].getAttribute("image");
              var slug = produceSlug(name);
              var game = {name, slug, "assets": [box], "platforms": ["origin"]};
              console.log(game);
              originApps.push(game);
              x++;
            }
            crawler.src = "https://www.origin.com/profile/achievements";
            waitForElement("l-origin-achievement-tile",function(){
              var page = document.getElementById("origin-crawler").contentWindow.document;
              var achievementTileTags = page.getElementsByClassName("l-origin-achievement-tile");

              var numberOfOriginGamesWithAchievements = achievementTileTags.length;
              console.log(achievementTileTags);
              x = 0;
              originDone = false;

              if(backgroundSyncActive){
                var delay = 936;
              }else{
                var delay = 100;
              }

              setInterval(function() {
                if(!originAchieverBusy){
                  if(x<numberOfOriginGamesWithAchievements){
                    addOriginAchievement(x);
                    x++;
                  }else{
                    if(originDone){

                    }else{

                      originComplete();
                      originDone = true;
                    }
                  }
                }
              }, delay);

            });
            console.log(originApps);
          });
        }
      }

      var originAchieverBusy = false;
      function addOriginAchievement(x){
        originAchieverBusy = true;
        var page = document.getElementById("origin-crawler").contentWindow.document;
        page.getElementsByClassName("origin-telemetry-pills-nav-item")[0].click();
        var crawler = document.getElementById("origin-crawler");
          waitForElement("l-origin-achievement-tile",function(){
            var page = document.getElementById("origin-crawler").contentWindow.document;
            var achievementTileTags = page.getElementsByClassName("l-origin-achievement-tile");
            console.log(achievementTileTags);
              page.getElementsByClassName("otkbtn-primary")[x+1].click();

              waitForElement("origin-achievementbadge-header",function(){
                if(page.getElementsByClassName("otkbtn-light")[0].innerHTML === "View All"){
                  console.log("viewMore");
                  page.getElementsByClassName("otkbtn-light")[0].click();
                }else{
                  console.log("viewLess");

                }
                var name = page.getElementsByClassName("origin-tile-overlay-content-title")[0].innerHTML;
                console.log(name);
                var slug = produceSlug(name);
                console.log(slug);
                var achievementTags = page.getElementsByClassName("origin-achievement-badgeitem");

                var achievements = [];
                console.log(achievementTags);
                y=0;
                while(y<achievementTags.length){
                  var achievementName = achievementTags[y].getElementsByClassName("origin-achievementbadge-title")[0].innerHTML;
                  var achievementDescription = achievementTags[y].getElementsByClassName("origin-achievementbadge-desc")[0].innerHTML;
                  var achievementImage = achievementTags[y].getElementsByTagName("img")[0].src;
                  var achievementUnlockTimeRaw = achievementTags[y].getElementsByClassName("origin-achievementbadge-date")[0].innerHTML;

                  if(achievementUnlockTimeRaw === "Not yet completed"){
                    var achievementUnlocked = "false";
                    var achievementUnlockTime =  null;
                    var achievementUnlockTimeRaw = null;
                  }else{
                    var achievementUnlocked = "true";
                    var achievementUnlockTime = parseOriginAchievementDate(achievementUnlockTimeRaw);
                  }


                  var achievement = {achievementName, achievementDescription, achievementImage, achievementUnlockTimeRaw,achievementUnlockTime, achievementUnlocked};
                  achievements.push(achievement);
                  y++;
                }


                console.log(achievements);

                y=0;
                while(y<originApps.length){
                  if(originApps[y]["slug"] === slug){
                    originApps[y]["achievements-origin"] = achievements;
                  }
                  y++;
                }
                originAchieverBusy = false;
              });


          });

      }

      function originComplete(){
        var crawler = document.getElementById("origin-crawler");
        crawler.src = "";
        console.clear();
        hideElement("origin-loading")
        showElement("origin-done");
        if(backgroundSyncActive){
          console.log("nowDoingUplay");
          uplaySignIn();
        }

        combineArrays();
      }
      //loadApp();
      //addOrigin();




      function waitForElement2(elementId, crawler, callBack){
        if(backgroundSyncActive){
          var delay = 431;
        }else{
          var delay = 50;
        }

        var page = document.getElementById(crawler).contentWindow.document;
        window.setTimeout(function(){
          var element = page.getElementsByClassName(elementId)[0];
          if(element){
            callBack(elementId, element);
          }else{
            waitForElement2(elementId, crawler, callBack);
          }
        },50)
      }




      function addUplay(){
        showElement("add-uplay");
        hideElement("database-import-load-screen");
        hideElement("steam-login");
        hideElement("steam-login-done");
        hideElement("add-gog");
        hideElement("add-origin");
        hideElement("uplay-crawler");
        hideElement("uplay-done");
        hideElement("uplay-loading");
      }
      var uplayGames = [];
      function uplaySignIn(){
        uplayGames = [];
        uplayComplete = false;
        userinfo["config"]["synced-stores"].push("uplay");
        hideElement("uplay-confirmation");
        hideElement("uplay-crawler-container");
        showElement("uplay-loading");
        var crawler = document.getElementById("uplay-crawler");
        var page = document.getElementById("uplay-crawler").contentWindow.document;
        crawler.src = "https://ubisoftconnect.com/en-GB/games/";
        crawler.style = "clip: rect(40px,490px,560px,0px); padding-top:-40px; position: absolute;";
        crawler.style.height = "700px";
        crawler.style.width = "500px";
        crawler.onload = function(){

          console.log("loadone");
          waitForElement2("login-modal", "uplay-crawler", function(){
            console.log("loaded");
            showElement("uplay-crawler-container");
            hideElement("uplay-loading");
            var page = document.getElementById("uplay-crawler").contentWindow.document;
            var crawler = document.getElementById("uplay-crawler");

            console.log(page.body.innerHTML);

          });
          waitForElement2("all-games-owned", "uplay-crawler",function(){
            showElement("uplay-loading");
            hideElement("uplay-crawler-container");
            var crawler = document.getElementById("uplay-crawler");
            crawler.style = "";
            crawler.style.height = "1920px";
            crawler.style.width = "1080px";
            var page = document.getElementById("uplay-crawler").contentWindow.document;
            console.log(page.body.innerHTML);

            var gameLinkTags1 = page.getElementsByClassName("lastplayed-list-section")[0].getElementsByTagName("a");
            console.log(gameLinkTags1);
            var gameLinkTags2 = page.getElementsByClassName("all-games-owned")[0].getElementsByTagName("a");


            x=0;
            var gameLinkTags = []

            while(x<gameLinkTags1.length){
              gameLinkTags.push(gameLinkTags1[x]);
              x++;
            }
            x=0;
            while(x<gameLinkTags2.length){
              gameLinkTags.push(gameLinkTags2[x]);
              x++;
            }
            console.log(gameLinkTags);
            x=0;

            while(x<gameLinkTags.length){
              var name = gameLinkTags[x].getAttribute("title");
              var slug = produceSlug(name);
              var statisticsUrl = "https://ubisoftconnect.com" + gameLinkTags[x].getAttribute("href");
              var game = {name, slug, statisticsUrl, "platforms" : ["uplay"]};
              console.log(game);
              uplayGames.push(game);
              x++;
            }

            crawler.src  = "https://ubisoftconnect.com/en-GB/dashboard/";
            crawler.onload = function(){
              console.log("loaded");
              waitForElement2("game-title", "uplay-crawler",function(){
                var crawler = document.getElementById("uplay-crawler");
                var page = document.getElementById("uplay-crawler").contentWindow.document;
                page.getElementsByClassName("badge-component")[0].click();
                console.log("clicked");
                waitForElement2("col-badge-item", "uplay-crawler",function(){
                  var crawler = document.getElementById("uplay-crawler");
                  var page = document.getElementById("uplay-crawler").contentWindow.document;
                  var uplayBadgeTags = page.getElementsByClassName("col-badge-item");
                  console.log(uplayBadgeTags);

                  var x = 1;
                  while(x < uplayBadgeTags.length){
                    var badgeImage = uplayBadgeTags[x].getElementsByTagName("img")[0].src;
                    var badgeName = uplayBadgeTags[x].getElementsByTagName("h1")[0].innerHTML.trim();
                    var slug = produceSlug(uplayBadgeTags[x].getElementsByTagName("p")[0].innerHTML);


                    var y= 0;

                    while(y<uplayGames.length){
                      if (uplayGames[y]["slug"] === slug){
                          if (typeof uplayGames[y]["badges-uplay"] === 'undefined') {
                            uplayGames[y]["badges-uplay"] = [];
                          }
                        uplayGames[y]["badges-uplay"].push({badgeName, badgeImage});
                      }

                      y++;
                    }

                    x++;
                  }
                  console.log(uplayGames);
                  crawler.src = "";
                //  console.clear();




                  crawler.src  = "https://store.ubi.com/" + userinfo["config"]["locale-ubi"] + "/wishlist";
                  crawler.onload = function(){
                    console.log("loaded");

                    //NEED TO IMPLEMENT THIS -- CURENTLY A CSP IS PREVENTING IT. MUST FIND A FIX!!!!!!

                    //waitForElement2("edit-button-wrapper", "uplay-crawler",function(){
                    //  var crawler = document.getElementById("uplay-crawler");
                    //  var page = document.getElementById("uplay-crawler").contentWindow.document;
                    //  //try{}
                    //  var wishlistCards = page.getElementsByClassName("wishlist-items-list")[0].getElementsByTagName("li");

                    //  var zt = 0;

                    //  while(zt < wishlistCards.length){
                    //    var slug = produceSlug(wishlistCardsp[zt].getElementsByClassName("prod-title")[0].innerHTML);
                    //    if(!userinfo["wishlist"].includes(slug)){
                    //      userinfo["wishlist"].push(slug);
                    //    }
                    //    zt++;
                    //  }
                      uplayDone();
                    //});
                  }

                });
              });
            }


            //we should probably add the uplay statistics function later


          });
        }

      }
      //addUplay();


      var uplayComplete = false;
      function uplayDone(){
        uplayComplete = true;
        hideElement("uplay-loading");
        showElement("uplay-done");
        combineArrays();
        if(backgroundSyncActive){
          epicSignIn();
        }
      }


      //epic games store
      //addEpic();
      function addEpic(){
        hideElement("database-import-load-screen");
        hideElement("steam-login");
        hideElement("steam-login-done");
        hideElement("add-gog");
        hideElement("add-origin");
        hideElement("add-uplay");
        showElement("add-epic");
        hideElement("epic-done");
        hideElement("epic-loading");
        hideElement("epic-crawler-container");
        showElement("epic-confirmation");
      }
      var epicComplete = false;
      function epicSignIn(){
        epicComplete = false;
        userinfo["config"]["synced-stores"].push("epic");
        hideElement("epic-confirmation");
        showElement("epic-loading");
        var crawler = document.getElementById("epic-crawler");
        var page = document.getElementById("epic-crawler").contentWindow.document;
        crawler.src = "https://www.epicgames.com/account/transactions";
        crawler.onload = function(){

          var crawler = document.getElementById("epic-crawler");
          var page = document.getElementById("epic-crawler").contentWindow.document;
          crawler.style.width = "400px";
          crawler.style.height = "600px"
          hideElement("epic-loading");
          showElement("epic-crawler-container");
          waitForElement2("title", "epic-crawler", function(){
            hideElement("epic-crawler-container");
            waitForElement2("order-status", "epic-crawler", function(){
              showElement("epic-loading");
              console.log("loaded-transactions");
              crawler.style.width = "1920px";
              crawler.style.height = "1080px"
              epicClickShowMore();
              if(backgroundSyncActive){
                hideElement("epic-crawler-container");
                hideElement("login-modal");
              }
            });
          });

          console.log("starting EpicCrawl");
          if(backgroundSyncActive){
            waitForElement2("MuiButtonBase-root", "epic-crawler", function(){
              showElement("epic-crawler-container");
              showElement("login-modal");
              hideElement("steam-login");
              hideElement("steam-login-done");
              hideElement("add-gog");
              hideElement("add-origin");
              hideElement("add-uplay");
              hideElement("finishing-crawl");
            });
          }
        }
      }

      var transactionsFullyExpanded = false;

      function epicClickShowMore(){
        console.log("epic: clicked show more");
        if(backgroundSyncActive){
          var delay = 5000;
        }else{
          var delay = 500;
        }
        setInterval(function() {
          var crawler = document.getElementById("epic-crawler");
          var page = document.getElementById("epic-crawler").contentWindow.document;
          if(page.getElementsByClassName("btn-custom")[0]){
            page.getElementsByClassName("btn-custom")[0].click();
          }else{
            if(transactionsFullyExpanded === false){
              transactionsFullyExpanded = true;
              epicSyncLibrary();

            }
          }
        }, delay);
      }
      var epicGames = [];
      var epicRefundedGames = [];
      function epicSyncLibrary(){
        console.log("lib_sync");
        var crawler = document.getElementById("epic-crawler");
        var page = document.getElementById("epic-crawler").contentWindow.document;
        var epicPurchTags = page.getElementsByClassName("payment-history-table")[0].getElementsByTagName("tr");
        console.log(epicPurchTags);
        var x = 1;

        while (x < epicPurchTags.length){
          if(epicPurchTags[x].getElementsByClassName("order-status")[0].innerHTML === "refunded"){
            epicRefundedGames.push(produceSlug(epicPurchTags[x].getElementsByClassName("order-description")[0].getAttribute("data-tip")));
          }else{
            var name = epicPurchTags[x].getElementsByClassName("order-description")[0].getAttribute("data-tip");
            var slug = produceSlug(name);
            var game = {name, slug, "platforms" : ["epic"]};
            console.log(game);
            if(epicRefundedGames.indexOf(slug)){
              epicGames.push(game);
            }else{
              console.log(slug + " has been refunded so was not pushed to epicGames array");

            }
          }
          x++;
        }
        crawler.src = "";
        console.clear();


        crawler.src  = "https://www.epicgames.com/store/en-US/wishlist";
        crawler.onload = function(){
          console.log("loaded");

          waitForElement2("css-1u88er4", "epic-crawler",function(){
            var crawler = document.getElementById("epic-crawler");
            var page = document.getElementById("epic-crawler").contentWindow.document;
            //try{}
            var wishlistNames = page.getElementsByClassName("css-1u88er4");
            console.log(wishlistNames);
            var zt = 0;

            while(zt < wishlistNames.length){
              var slug = produceSlug(wishlistNames[zt].innerHTML);
              if(!userinfo["wishlist"].includes(slug)){
                userinfo["wishlist"].push(slug);
              }
              zt++;
            }
            crawler.src = "";
            epicDone();
          });
        }







      }

      function epicDone(){
        epicComplete = true;
        hideElement("database-import-load-screen");
        hideElement("steam-login");
        hideElement("steam-login-done");
        hideElement("add-gog");
        hideElement("add-origin");
        hideElement("add-uplay");
        showElement("add-epic");
        hideElement("epic-done");
        hideElement("epic-loading");
        hideElement("epic-crawler-container");
        hideElement("epic-crawler");
        hideElement("epic-confirmation");
        hideElement("epic-loading");
        showElement("epic-done");
        var epicGamesDone = true;
        combineArrays();
      }

      var syncComplete = false;

      async function updateUserGames(){
        await writeFile("userdata/usergames.json", await JSON.stringify(usergames, null, 2));
      }



      function finishSync(){
        hideElement("app");
        hideElement("login-modal");
        hideElement("add-origin");
        hideElement("steam-login");
        hideElement("steam-login-done");
        hideElement("add-gog");
        hideElement("add-uplay");
        hideElement("add-epic");
        hideElement("finishing-crawl");
        hideElement("crawl-finished");
        hideElement("database-import-load-screen");
        hideElement("database-import-load-screen");
        hideElement("steam-login");
        showElement("finishing-crawl");

        window.setInterval(async function(){
          if(gogInitiated === true){
            if(gogDone & steamDone){
              if(syncComplete !== true){
                userinfo["config"]["firstTime"] = "no";
                await combineArrays();
                await updateUserGames();
                await updateUserData();

                window.setTimeout(async function(){


                  loadApp();

                },1500);

                syncComplete=true;

              }else{

              }
            }
          }
        }, 100);

        //await loadApp();
      }




      async function mainLoadProcess(){
        hideElement("wishlist-notification");
        hideElement("modal");
        showElement("loading-big");
        hideElement("login-modal");
        hideElement("syncing-notice");

        console.log("importing database");


        await importUserGames();
        await importUserData();
        await importDatabaseLocal();
        await importImageDatabase();
        try{
          await importProtonDB();
        }catch{

        }

        await fetchInstalledGames();
        await downloadUsergamesImages();





        console.log("database imported");


        afterLoad();
      }
  /*    var windowWidth =  window.innerWidth;
      var windowHeigth =  window.innerHeight;
      var windowSize = {windowWidth, windowHeigth};
*/

        setInterval(function(){
          backgroundSync();
        },1000*60*15);
       function afterLoad(){
         setTimeout(function(){
         if(userinfo["config"]["defaultLoadPage"] = "recentActivity"){
           loadLibrarySection("recentActivity");

         }else{
           loadLibrarySection(userinfo["config"]["defaultLibraryView"][0], userinfo["config"]["defaultLibraryView"][1]);
         }


       }, 1);
        console.log("afterLoad");
        try{
          if(userinfo["config"]["firstTime"] === "yes"){
            sync();
          }else{
            setTimeout(function(){
              checkForUserOnsaleGamesAndNotify();
            },1000*60*60);
            if(userinfo["config"]["backgroundSyncOnStartupEnabled"] === "yes"){
              backgroundSync();
            }
          }
        }
        catch{

        }







      }

      function loadApp(){
        showElement("loading-big");
        mainLoadProcess();
        afterLoad();


      }

      adjustWindowSize(100 ,100);
      setTimeout(function(){


        loadApp();

      },50);

      async function importUserGames(){
        usergames = JSON.parse(await readfile("userdata/usergames.json"));
      }

      //eg loadLibrarySection("genre", "rpg")
      //eg loadLibrarySection("developer", "Bioware")
      function loadLibrarySection(view, extra = null){
        hideElement("recent-activity");
        if(view === "recentActivity"){
          produceRecentActivity();
          var view = userinfo["config"]["defaultLibraryView"][0];
          var extra = userinfo["config"]["defaultLibraryView"][1];
        }else{
          hideElement("recent-activity");
        }

        if(extra === ""){
          extra = null;
        }
        deactivateBadgeDataslips();
        hideElement("login-modal");
        showElement("app");
        hideElement("store");
        hideElement("game");
        showElement("library");
        showElement("sidebar");
        showElement("content-header");
        document.getElementById("library").innerHTML= "";


        populateLibraryWithCards(view, extra);

        refreshCategories();

      }
      var userslugs = [];
      var userslugsGlobal = [];

      async function populateLibraryWithCards(view, extra = null){
        if(view !== "custom"){
          if(extra !== null){
            console.log(produceSlug(extra));
            document.getElementById("current-section").innerHTML = produceSlug(extra);
          }else{
            if(view === "all"){
              document.getElementById("current-section").innerHTML = "all-games";
            }else{
              console.log(produceSlug(view));
              document.getElementById("current-section").innerHTML = produceSlug(view);
            }

          }
        }

        document.getElementById("current-page").innerHTML = "library";
        var x=0;

        userslugs = [];
        userslugsGlobal = [];
        while(x<usergames.length){
          await userslugsGlobal.push(usergames[x]["slug"]);
          x++;
        }

        if(view === "all"){
          x=0;
        while(x<usergames.length){
          await userslugs.push(usergames[x]["slug"]);
          x++;
        }

          await userslugs.sort();
        }else if(view === "genre"){
          if(!databaseImported){
            await importDatabase();
          }
          x=0;
          while (x<usergames.length){
            var slug = usergames[x]["slug"];
            var game = await DBgameSLG(slug);
            if(game === "not found"){

            }else{
              try{
                if(game["info"]["genres"].includes(extra)){
                  await userslugs.push(slug);
                }else{
                }
              }catch{

              }

            }
            x++;
          }
        }else if(view === "developer"){
          if(!databaseImported){
            await importDatabase();
          }
          x=0;
          while (x<usergames.length){
            var slug = usergames[x]["slug"];
            var game = await DBgameSLG(slug);
            if(game === "not found"){
            }else{
              try{
                if(game["info"]["developers"].includes(extra)){
                  await userslugs.push(slug);
                }else{
                }
              }catch{

              }

            }
            x++;
          }
        }else if(view === "publisher"){
          if(!databaseImported){
            await importDatabase();
          }
          x=0;
          while (x<usergames.length){
            var slug = usergames[x]["slug"];
            var game = await DBgameSLG(slug);
            if(game === "not found"){
            }else{
              try{
                if(game["info"]["developers"].includes(extra)){
                  await userslugs.push(slug);
                }else{
                }
              }catch{

              }

            }
            x++;
          }
        }else if(view === "launcher"){
          x=0;
          while (x<usergames.length){
            var slug = usergames[x]["slug"];
            var platforms = usergames[x]["platforms"];
            if(platforms.includes(extra)){
              await userslugs.push(slug);
            }
            x++;
          }
        }else if(view === "custom"){
          console.log("custom");
          try{
            try{
              userslugs = userinfo["categories"][extra]["games"];
            }catch{
              userslugs = [];
              loadLibrarySection("all");
            }

            document.getElementById("current-section").innerHTML = produceSlug(userinfo["categories"][extra]["name"]);
          }catch{

          }

        }else if(view === "installed"){
          var x = 0;
          userslugs = []
          while (x<usergames.length){
            if (usergames[x]["installed"] == true){
              userslugs.push(usergames[x]["slug"]);
            }
            x++;
          }
          await userslugs.sort();
        }

          try{
            makeLibraryCards(userslugs);
          }catch{

          }

      }

      async function makeLibraryCards(userslugs){
        y=0;
        while(y<userslugs.length){
          await produceLibraryCard(userslugs[y]);
          y++;

        }

      }



      async function produceLibraryCard(slug, sendBack = false){
        var libraryEl = document.getElementById("library");

        var isGame = false;




        var game = usergamesSLG(slug);
        if(game["platforms"].includes("origin")){
          console.log(game);
          var box = game["assets"][0];
          var title = game["name"];
           isGame = true;
        }else if(game["platforms"].includes("steam")){
          console.log(game);

          if(typeof box !== "undefined"){
            console.log("steam found");
            var box = game["assets"]["box"];
            var title = game["name"];
            isGame = true;
          }
        }


        if(typeof(box) !== "undefined"){

        }else{
          var dbgame = await DBgameSLG(slug);
          if(dbgame !== "not found"){
            var box = dbgame["assets"]["box"];
            if(box === null){
              var box = dbgame["assets"]["header"];
            }
            var title = dbgame["appName"];
             isGame = true;
          }else{
            isGame = false;
          }
        }
        /*
        if(!isGame){
          if(game["platforms"].includes("origin") || game["platforms"].includes("gog") || game["platforms"].includes("uplay")){
            isGame = true;
          }
        }
        */
        if(isGame){
          if(typeof(box) !== "undefined"){
            var boxcode = await produceImageUrl(box);
          }else{
            var boxcode = "";
          }

          if(usergamesSLG(slug)["installed"] == true){
            installedStatus = "installed";
          }else{
              var installedStatus = "uninstalled";
          }
          var libraryCardCode = `<div class="library-card ` + installedStatus + ` smooth" alt="` + await game["appName"] + `" onclick="showGame('` + slug + `')" style="background-image: url('` + boxcode + `')">`;

          if(sendBack){
            return(libraryCardCode);
          }else{
            libraryEl.innerHTML+= libraryCardCode;
          }


        }

        //console.clear();
      }







      // to enable fancy animations on the library tiles - from stack overflow https://stackoverflow.com/questions/24294452/detect-mouse-direction-javascript#24294639

      var direction = "";
      var oldx = 0;
      var oldy = 0;
      mousemovemethod = function (e) {

       if (e.pageX > oldx && e.pageY == oldy) {
                      direction="dir-right";
                  }
                  else if (e.pageX == oldx && e.pageY > oldy) {
                      direction="dir-down";
                  }
                  else if (e.pageX == oldx && e.pageY < oldy) {
                      direction="dir-up";
                  }
                  else if (e.pageX < oldx && e.pageY == oldy) {
                      direction="dir-left";
                  }

                  if(velocity>1.5){
                    document.getElementById("library").className = direction + " _veryfast";
                  }else if(velocity>1){
                    document.getElementById("library").className = direction + " _fast";
                  }else if(velocity>0.15){
                    document.getElementById("library").className = direction;
                  }
                  document.getElementById("game").className = direction;
                  document.getElementById("recent-activity").className = direction;
              oldx = e.pageX;
              oldy = e.pageY;

      }



      var prev_time = new Date();
      var prev_pos_y = 0;
      var velocity;
      function getMouseVelocity(e) {

      var now = new Date();
      current_pos_y = e.pageY;

      time_interval = now.getTime() - prev_time.getTime();

      if(time_interval != 0)
          {
              speed = ( Math.abs(current_pos_y - prev_pos_y) / time_interval );
      }
      else
          speed = 0;

      velocity = speed;



      prev_time = now;
      prev_pos_y = current_pos_y;


      };

      document.addEventListener('mousemove', mousemovemethod);
      document.addEventListener('mousemove', getMouseVelocity);


      var userinfo = [];
      function createCategory(name , type, primary, secondary = null){
        console.log(userinfo);
        if(type === "auto"){
          var view = primary;
          var extra = secondary;
          userinfo["categories"].push( {name, type, view, extra});
        }
        if(type === "manual"){
          var games = primary;
          userinfo["categories"].push({name, type, games})
        }
        updateUserData();
        refreshCategories();
      }
      function refreshCategories(){
        var libraryCategories = document.getElementById("sidebar-library");
        libraryCategories.innerHTML = "";
        x=0;
        while(x< userinfo["categories"].length){
          if(userinfo["categories"][x]["type"] === "auto"){
            libraryCategories.innerHTML+= `<li onclick="loadLibrarySection('` + userinfo["categories"][x]["view"] + `','` + userinfo["categories"][x]["extra"] +`')">` + userinfo["categories"][x]["name"] + `<span class="button" onClick="deleteCategory(` + x + `)"><i class="fas fa-trash-alt"></i></span></li>`;
          }else if(userinfo["categories"][x]["type"] === "manual"){
            libraryCategories.innerHTML+= `<li onclick="loadLibrarySection('custom','` +  x +`')">` + userinfo["categories"][x]["name"] + `<span class="button" onClick="deleteCategory(` + x + `)"><i class="fas fa-trash-alt"></i></span></li>`;
          }
          x++;
        }

      }

      function deleteCategory(x){
        userinfo["categories"].splice(x, 1);
        try{
          refreshCategories();
          updateUserData();
        }catch{

        }

      }


      async function updateUserData(){
        console.log(userinfo);
        await writeFile("userdata/userinfo.json", await JSON.stringify(userinfo, null, 2));
      }
      async function importUserData(){
        userinfo = JSON.parse(await readfile("userdata/userinfo.json"));
        console.log("userdata_imported");
      }


      function openModal(name){
        modalActive = true;
        hideModal()
        showElement("modal");
        showElement(name);
        modalHeader = document.getElementById("modal-header-content");
        if(name === "plus-menu"){
          modalHeader.innerHTML = "Add product or category";
        }else if(name === "activate-product"){
          modalHeader.innerHTML = "Activate a product";
        }else if(name === "game-install"){
          modalHeader.innerHTML = "Install a game";
        }
      }
      function openPlusMenu(){
        openModal("plus-menu");

      }

      function hideModal(){
        hideElement("modal");
        hideElement("plus-menu");
        hideElement("activate-product");
        hideElement("add-category");
        hideElement("game-install");
      }

      function activateGameSteam(){
        ipcRenderer.send('activateGameSteam');
        hideModal();
      }
      function activateGameEpic(){
        openUrlInBrowser("https://www.epicgames.com/account/code-redemption");
        hideModal();
      }
      function activateGameGOG(){
        openUrlInBrowser("https://www.gog.com/redeem");
        hideModal();
      }


      var currentCatView = "";
      window.setInterval(async function(){
        var newCatValue = await document.getElementById("add-cat-view").value;
        if(newCatValue !== currentCatView){

          if(newCatValue === "all" || newCatValue === "installed" ){
            hideElement("add-cat-extra");
            //document.getElementById("modal").className = "mini";
          }else{
            showElement("add-cat-extra");
            //document.getElementById("modal").className = "normal";
          }
          currentCatView = newCatValue;
          if(newCatValue === "launcher"){
            document.getElementById("add-cat-extra-list").innerHTML = "";


            document.getElementById("add-cat-extra-list").innerHTML += "<option value='steam' label='Steam'>";
            document.getElementById("add-cat-extra-list").innerHTML += "<option value='epic' label='Epic Games Store'>";
            document.getElementById("add-cat-extra-list").innerHTML += "<option value='uplay' label='Ubisoft Connect'>";
            document.getElementById("add-cat-extra-list").innerHTML += "<option value='gog' label='GOG'>";
            document.getElementById("add-cat-extra-list").innerHTML += "<option value='origin' label='EA Origin'>";
          }

          if(newCatValue === "developer"){
            var developers = await fetchUsergamesDevelopers();
            document.getElementById("add-cat-extra-list").innerHTML = "";
            var x=0;
            while(x<developers.length){
              document.getElementById("add-cat-extra-list").innerHTML += "<option value='" + developers[x] + "'>";
              await x++;
            }
          }

          if(newCatValue === "publisher"){
            var publishers = await fetchUsergamesPublishers();
            document.getElementById("add-cat-extra-list").innerHTML = "";
            var x=0;
            while(x<publishers.length){
              document.getElementById("add-cat-extra-list").innerHTML += "<option value='" + publishers[x] + "'>";
              await x++;
            }
          }

          if(newCatValue === "genre"){
            var genres = await fetchUsergamesGenres();
            document.getElementById("add-cat-extra-list").innerHTML = "";
            var x=0;
            while(x<genres.length){
              document.getElementById("add-cat-extra-list").innerHTML += "<option value='" + genres[x] + "'>";
              await x++;
            }
          }


        }
      }, 50);


      async function updateGamesListInModal(){
        var y=0;
        document.getElementById("gameNames").innerHTML = "       ";
        console.log(userslugsGlobal.length);
        while(y<userslugsGlobal.length){
          var game = await DBgameSLG(userslugsGlobal[y]);
          console.log(game, userslugsGlobal[y]);



            document.getElementById("gameNames").innerHTML += '<option>';
            document.getElementById("gameNames").getElementsByTagName("option")[y].value = userslugsGlobal[y];
            try{
              document.getElementById("gameNames").getElementsByTagName("option")[y].label = game["appName"];
            }catch{

            }

          await y++;
        }
      }





      async function fetchUsergamesDevelopers(){
        var x=0;
        var developers = [];
        while(x<userslugsGlobal.length){
          try{
            var game = await DBgameSLG(userslugsGlobal[x]);
            var game_developers = await game["info"]["developers"]
            var z=0;
            while(z<game_developers.length){
              await developers.push(game_developers[z]);
              await z++;
            }
          }catch{

          }

          await x++;

        }
        return [...new Set(developers)].sort();
      }

      async function fetchUsergamesPublishers(){
        var x=0;
        var publishers = [];
        while(x<userslugsGlobal.length){
          try{
            var game = await DBgameSLG(userslugsGlobal[x]);
            var game_publishers = await game["info"]["publishers"]
            var z=0;
            while(z<game_publishers.length){
              await publishers.push(game_publishers[z]);
              await z++;
            }
          }catch{

          }

          await x++;

        }
        return [...new Set(publishers)].sort();
      }

      async function fetchUsergamesGenres(){
        var x=0;
        var genres = [];
        while(x<userslugsGlobal.length){
          try{
            var game = await DBgameSLG(userslugsGlobal[x]);
            var game_genres = await game["info"]["genres"]
            var z=0;
            while(z<game_genres.length){
              await genres.push(game_genres[z]);
              await z++;
            }
          }catch{

          }

          await x++;

        }
        return [...new Set(genres)].sort();
      }

      function createCategoryFromModal(){


        var type = createCategoryType;
        var name = document.getElementById("add-cat-name").value;
        var primary = document.getElementById("add-cat-view").value


        if(name!== ""){
          console.log(primary);
          var secondary = document.getElementById("add-cat-extra").value
          console.log(secondary);
          if(type === "automatic"){
            if(name === "all"){
              createCategory(name , "auto", primary, null);

            }else{
                createCategory(name , "auto", primary, secondary);
            }


          }else if(type === "manual"){

            var catTags = document.getElementById("gameNames_Container").getElementsByClassName("gameName");

            x = 0;


            var catSlugs = [];
            while(x < catTags.length){
              catSlugs.push(catTags[x].value);
              x++;
            }
            console.log(catSlugs);

            x = 0;
            createCategory(name , "manual", catSlugs);

          }
        }


      }

//      <form id="gameNames_Container">
//        <div class="gameName-cover" id="gameName_1">
//          <input list="gameNames" class="gameName" ><span class="button" onClick="removeGameNameFromManualDetails(1)"><i class="fas fa-trash-alt"></i></span><span class="button" onClick="addGameNameToManualDetails()"><i class="fas fa-plus"></i></span>
//        </div>
//        <datalist id="gameNames">
//
//        </datalist>
//      </form>


      var manualGameNameDetailsNumber = 0;
      addGameNameToManualDetails()
      function addGameNameToManualDetails(){

        var catTags = document.getElementById("gameNames_Container").getElementsByClassName("gameName");

        x = 0;


        var catSlugs = [];
        while(x < catTags.length){
          catSlugs.push(catTags[x].value);
          x++;
        }

        catSlugs.push ("")

        manualGameNameDetailsNumber++;

        x=0;

        document.getElementById("gameTags_input_container").innerHTML = " ";

        while(x<manualGameNameDetailsNumber){
          document.getElementById("gameTags_input_container").innerHTML += `<div class="gameName-cover" id="gameName_`  + x  + `">          <input list="gameNames" class="gameName" value="`+  catSlugs[x] +`"><span class="button" onClick="removeGameNameFromManualDetails(` + x  + `)"><i class="fas fa-trash-alt" ></i></span><span class="button" onClick="addGameNameToManualDetails()"><i class="fas fa-plus"></i></span>        </div>`;
          x++;
        }



      }


      function removeGameNameFromManualDetails(number){
        document.getElementById("gameName_" + number).remove();
        manualGameNameDetailsNumber--;
      }

      function loadStoreSection(page, extra = null){
        hideElement("wishlist-notification");
        hideElement("login-modal");
        showElement("app");
        showElement("store");
        hideElement("library");
        hideElement("game");
        showElement("sidebar");
        showElement("content-header");
        hideElement("wishlist");
        showElement("loading-big");


        if(page === "wishlist"){
          if(extra == "onSaleOnly"){
            populateWishlist(true);
          }else{
            populateWishlist();
          }

          showElement("wishlist");
          hideElement("recent-activity");
          hideElement("loading-big");
        }else if (page === "game"){
          hideElement("wishlist");

        }

      }


/*  <div id="wishlist">
    <div class="wishlist-game"  onclick="loadWishlistGame(0);" style="background-image:url('https://cdn2.unrealengine.com/egs-hitman3-iointeractiveas-g1a-00-1920x1080-604023665.jpg?h=720&resize=1&w=1280');">
      <div class="wishlist-game-header" style="background-image:url('https://cdn2.unrealengine.com/egs-hitman3-iointeractiveas-s1-2560x1440-604024769.jpg?h=480&resize=1&w=854');">
      </div>
      <div class="wishlist-game-content">
        <div class="left">
          <div class="wishlist-game-title">
          HITMAN 3
          </div>
          <div class="wishlist-game-info">
            IO Interactive A/S
          </div>
        </div>
        <div class="right">
          <div class="wishlist-game-discount-percent">
            - 25%</div>
          <div class="wishlist-price-container">
            <span class="wishlist-currency-indicator"></span><span class="wishlist-price">37.49
            </span>
          </div>
          <div class="wishlist-store-page-link">View Pricing History</div>
        </div>
      </div>
    </div>
  </div>
  */
      async function populateWishlist(onsaleonly = false){
        document.getElementById("current-section").innerHTML = "wishlist";
        document.getElementById("current-page").innerHTML = "store";
        var x = 0;
        document.getElementById("wishlist").innerHTML = ""
        while(x<userinfo["wishlist"].length){
          var game = await DBgameSLG(userinfo["wishlist"][x]);
          console.log(game);
          if(game === "not found"){
            x++;
          }else {
            var title = game["appName"];
            var background = game["assets"]["hero"];
            if(background === null){
              var background = game["assets"]["screenshots"][0];
            }
            var header = game["assets"]["header"];
            try{
              var developer = game["info"]["developers"][0];
            }catch{
              var developer = "";
            }



            //needs proper implementation when crawler is sorted out
            // currency indicator needs to be dynamic
            var price ="" ;
            var discountPercentage = Math.round((await calculateDiscountPercentage(userinfo["wishlist"][x]))*100);
            var price =  (await calculateDiscountPercentage(userinfo["wishlist"][x], "lowestPrice"));
            if(price == ""){
              var price = "?";
            }
            var store =  (await calculateDiscountPercentage(userinfo["wishlist"][x], "lowestStore"));
            var discountPercentCode = `<div class="wishlist-game-discount-percent">
                        - ` + discountPercentage +`%</div>`;

            var onsale = true;
            if(discountPercentage < 5 || isNaN(discountPercentage)){
              var discountPercentCode = "";
              if(onsaleonly){
                var onsale = false;
              }

            }

            if(onsale){


              document.getElementById("wishlist").innerHTML += `
                  <div class="wishlist-game" id="wishlist-game-` +  userinfo["wishlist"][x] +`" onclick="loadWishlistGame('` + userinfo["wishlist"][x] + `');" style="background-image:url('` + background + `');">
                    <div class="wishlist-game-header" style="background-image:url(' `  + header +`');">
                    </div>
                    <div class="wishlist-game-content">
                      <div class="left">
                        <div class="wishlist-game-title">
                        ` + title +`
                        </div>
                        <div class="wishlist-game-info">
                          `  + developer  + `
                        </div>
                      </div>
                      <div class="right">
                      ` + discountPercentCode +`
                        <div class="wishlist-price-container">
                          <span class="wishlist-currency-indicator">&pound;</span><span class="wishlist-price">` +  price  +  `
                          </span>
                        </div>
                        <div class="wishlist-store-page-link">View Pricing History</div>
                      </div>
                    </div>
                  </div>
                `
              }
              x++;
          }
        }
      }

      function loadWishlistGame(slug){
        document.getElementById("wishlist-game-" + slug).className += " loading";
        buyGame(slug);
        setTimeout(function () {
            //loadStoreSection("game", userinfo["wishlist"][x]);
            document.getElementById("wishlist-game-" + slug).className += "wishlist-game";
        },900);
      }
      async function buyGame(slug){
        var store =  (await calculateDiscountPercentage(slug, "lowestStore"));
        console.log(store);

        var game = await DBgameSLG(slug);

        if(store == "steam"){
          openUrlInBrowser(game["info"]["steamUrl"]);
        }else if(store == "gog"){

          if(typeof(game["info"]["gogUrl"]) !== "undefined"){
            openUrlInBrowser(game["info"]["gogUrl"]);
          }else{
            if(URLExists("https://www.gog.com/game/" + game["slug"].replaceAll("-", "_"), true)){
              openUrlInBrowser("https://www.gog.com/game/" + game["slug"].replaceAll("-", "_"));
            }else{
              console.log("url " + "https://www.gog.com/game/" + game["slug"].replaceAll("-", "_") + "  does not exist");
            }
          }
        }else if(store == "humble"){
          openUrlInBrowser(game["info"]["humbleUrl"]);
        }else if(store == "fanatical"){
          openUrlInBrowser(game["info"]["fanaticalUrl"]);
        }
      }


      //sync();
    </script>


    <script>
      function loadGameStorePage(slug){

      }
    </script>



    <script>

        async function showGame(slug){
          refreshCategories();
          hideElement("login-modal");
          hideElement("wishlist-notification");
          hideElement("search-box");

          showElement("loading-big");
          showElement("app");
          hideElement("store");
          hideElement("recent-activity");
          hideElement("library");
          showElement("sidebar");
          showElement("content-header");
          document.getElementById("recent-activity").innerHTML = "";

          var game = usergamesSLG(slug);
          var gameDB = await DBgameSLG(slug);
          console.log(game);
          console.log(gameDB);
          if(game === "not found"){
            return;
          }
          if(gameDB === "not found"){
            if(game["platforms"].includes("steam") && DBgameSTEAMID(game["steamid"]) !== "not found"){
              gameDB =  DBgameSTEAMID(game["steamid"]);
            }else if(game["platforms"].includes("gog") && DBgameSTEAMID(game["gogID"]) !== "not found"){
              gameDB =  DBgameGOGID(game["gogID"]);
            }else{
              gameDB= {"info": {}, "assets": {"background": "assets/polyfill.png"}};
            }
          }


            if(typeof gameDB["assets"]["hero"] !== 'undefined'){
              var background = gameDB["assets"]["hero"];
            }


            if(background == null || typeof(background) == "undefined"){
              var background = gameDB["assets"]["background"];
            }



          if(background == null || typeof(background) == "undefined"){
            var background =  gameDB["assets"]["screenshots"][gameDB["assets"]["screenshots"].length - 1];
          }

          if(background == null || typeof(background) == "undefined"){
            var background = ":local:assets/polyfill.png";
          }

          if(typeof gameDB["assets"]["logo"] !== 'undefined'){
            var logo = gameDB["assets"]["logo"];
          }

          if(game["installed"] == true){
            var gameHeader = `<div   class="game-header installed" style="background-image: url('` + produceImageUrl(background) + `')" onClick = "launchGame('` + slug +`')">`;

          }else{
            var gameHeader = `<div class="game-header uninstalled" style="background-image: url('` + produceImageUrl(background) + `')">`;
          }


          document.getElementById("game").innerHTML = gameHeader + `
            <div class="game-logo">
              <img src="` + produceImageUrl(logo) + `">

            </div>
          </div>
          <div class="main-game">
            <div class="centre-content">
              <div class="large-text-top" id="news-text">

              </div>
              <div class="news-carousel">

              </div>
              <div class="large-text-top" id="achievements-text">

              </div>
              <div class="achievements-row-game">

              </div>
            </div>

            <div class="right-content">
              <div class="statistics">
                <ul>


                </ul>
              </div>
              <div class="the-badges-wrapper">
                <div class="badges">

                </div>
              </div>
              <hr>
              <div class="game-info">
                <ul>

                </ul>


              </div>
              <hr>
              <div class="game-settings">

              <h3 class="sidebar-header">Game Settings</h3>

                <ul>



                </ul>
              </div>
            </div>
          </div>`;



          var achievements = game["achievements-steam"];

          if(typeof(achievements) == "undefined"){
              if(typeof(game["achievements-origin"]) == "undefined"){
                var achievements = game["achievements-gog"];
              }else{
                var achievements = game["achievements-origin"];
              }


          }
          try{
            var achievements = sortAchievementsByDate(achievements);
          }catch{
            console.error("sorting achievements failed");
          }

          if(typeof(calculateGameCompletion(slug)) !== "undefined"){
            document.getElementsByClassName("statistics")[0].getElementsByTagName("ul")[0].innerHTML+= `<li>Completion<span class="stat">` + calculateGameCompletion(slug)  + `%</li> <!-- maybe add average completion on graph as yellow or other different colour-->`;
          }

        /*  if(){
            document.getElementsByClassName("statistics")[0].getElementsByTagName("ul")[0].innerHTML+= `                  <li>Completion<span class="stat">` + calculateGameCompletion(slug)  + `%</li> <!-- maybe add average completion on graph as yellow or other different colour-->
                              <li>Playtime<span class ="stat">22.9hours</li>
                              <li>Last Played<span class ="stat">1/7/2021</li>`;
          }
*/
          var lastPlayed = game["last-played"];
          if(typeof(lastPlayed) !== "undefined"){
            document.getElementsByClassName("statistics")[0].getElementsByTagName("ul")[0].innerHTML+= `<li>Last Played<span class ="stat">` + lastPlayed.split("-").reverse().join("/") + `</li>`;
          }




          if(typeof(achievements) !== "undefined" && achievements.length > 0){
            if(achievements[0]["achievementUnlocked"] == "true"){
              if(typeof(lastPlayed == "undefined")){
                var lastPlayed  = achievements[0]["achievementUnlockTime"];
                if(document.getElementsByClassName("statistics").length < 1){
                  document.getElementsByClassName("statistics")[0].getElementsByTagName("ul")[0].innerHTML+= `<li>Last Played<span class ="stat">` + lastPlayed.split("-").reverse().join("/") + `</li>`;
                }
              }
            }
            if (achievements.length > 0){
              var y = 0;
              document.getElementById("achievements-text").innerHTML = "Achievements";

              while(y<achievements.length){

                if(achievements[y]["achievementUnlocked"] == "true"){
                  var unlockedText = "unlocked";
                }else{
                  var unlockedText = "locked";

                }
                if(achievements[y]["achievementDescription"] !== "null" & typeof(achievements[y]["achievementDescription"]) !== "undefined"){
                          var achievementDescription    =      `<div class="achievement-description"> ` + achievements[y]["achievementDescription"] + ` </div>`;
                 }else{
                   var achievementDescription = ""
                 }

                 if(typeof(achievements[y]["achievementRarity"]) !== "undefined"){

                   if(achievements[y]["achievementRarity"] < 5){
                     var rarityText = "rare";
                   }else if(achievements[y]["achievementRarity"] < 20){
                     var rarityText = "uncommon";
                   }else if(achievements[y]["achievementRarity"] < 40){
                     var rarityText = "medium";
                   }else if(achievements[y]["achievementRarity"] < 60){
                     var rarityText = "common";
                   }
                   console.log(rarityText);
                   var achievementRarity = `<div class="achievment-rarity">
                     <span class="rarity-percentage">` + achievements[y]["achievementRarity"] + `%</span> of users have this achievement
                   </div> `;
                 }else{
                    var achievementRarity = "";
                    var rarityText = "common";
                  }
                  try{
                    var unlockTime =achievements[y]["achievementUnlockTime"];
                    console.log(unlockTime);
                    var unlockTimeNormal = unlockTime.split("-").reverse().join("/");
                  }catch{
                    var unlockTime =achievements[y]["achievementUnlockTimeRaw"];

                  }

                document.getElementsByClassName("achievements-row-game")[0].innerHTML += `<div class="achievement-game ` + unlockedText + ` ` + rarityText + `">
                  <div class="achievement-badge" style="background-image: url('` + produceImageUrl(achievements[y]["achievementImage"]) +`')">

                  </div>
                  <div class="achievement-onclick-description">
                    <div class="achievement-name">`
                    + achievements[y]["achievementName"] +  `        </div> ` + achievementDescription + `

                    <div class="achievment-unlock-date"> Unlocked on
                      ` + unlockTimeNormal + `
                    </div> ` + achievementRarity + `</div>
                </div>`;
                y++;
              }
            }

          }

          var badges = game["badges-steam"];

          if(typeof(badges) == "undefined"){
            var badges = game["badges-uplay"];
          }else if(typeof(game["badges-uplay"]) !== "undefined"){
            var badges = badges.concat(game["badges-uplay"]);
          }

          var z = 0;
          try{
            while(z<badges.length){
              console.log(badges);
              if(badges[z]["badgeImage"].includes("ubi.com")){
                var ubiText = " uplay";
                var badgeUrl = produceImageUrl(badges[z]["badgeImage"]);
              }else{
                var ubiText = "";
                var badgeUrl = badges[z]["badgeImage"];
              }

              document.getElementsByClassName("badges")[0].innerHTML += `<div class="badge` + ubiText + `" onmouseover="activateBadgeDataslip(` + z + `)" onmousedown="activateBadgeMove(` + z + `);" onmouseup="stopBadgeMove(` + z + `)">
                <div class="badge-image"  style="background-image:url('` + badgeUrl +`')">
                </div>
                <div class="badge-hover-text">` + badges[z]["badgeName"] +`</div>
              </div>`;
              z++;
            }
            if(badges.length<1){
              document.getElementsByClassName("the-badges-wrapper")[0].remove();
            }


          }catch{
            document.getElementsByClassName("the-badges-wrapper")[0].remove();

          }



          hideElement("loading-big");


          if(typeof(gameDB["steamID"] !== "undefined")){
            addNewsToGamePage(gameDB["steamID"])
          }
          document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML ="";
          console.log(document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML ="");
          document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML += "<li>" + gameDB["appName"] + "</li>";

            if(typeof(gameDB["info"]["publishers"]) !== "undefined"  && typeof(gameDB["info"]["developers"]) !== "undefined"){
              document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML += "<li>Devs: " + gameDB["info"]["developers"][0] + "<wbr> / " + gameDB["info"]["publishers"][0] + "</li>";
            }else{
              if(typeof(gameDB["info"]["developers"]) !== "undefined"){
                document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML += "<li>" + gameDB["info"]["developers"][0] + "</li>";
              }else if(typeof(gameDB["info"]["publishers"]) !== "undefined"){
                document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML += "<li>" + gameDB["info"]["publishers"][0] + "</li>";
              }
            }

          if(typeof(gameDB["info"]["steamReviewScore"]) !=="undefined" && gameDB["info"]["steamReviewScore"] !==  "null"){
            var score = gameDB["info"]["steamReviewScore"];
            var starScore = Math.round(score/10);
            if(starScore % 2 === 0 ){
              var starText ='<i class="far fa-star"></i>'.repeat(starScore/2);
            }else{
                var starText ='<i class="far fa-star"></i>'.repeat((starScore-1)/2) + '<i class="far fa-star-half"></i>';
            }
            document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML += "<li id ='reviewStars'>Steam: " + starText + "(" +  gameDB["info"]["steamReviewScore"] + "%)</li>";
          }
          try{
            if(typeof(gameDB["info"]["genres"]) !== undefined && gameDB["info"]["genres"] !==  "null"){
              var genres = gameDB["info"]["genres"];
              var genresText = "";
              var p = 0;
              while(p<genres.length){
                genresText +=  genres[p] + "/";
                p++;
              }
              var genresText = genresText.slice(0, -1);
              document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML += "<li id ='genres'>" + genresText + "</li>";

            }
          }catch{

          }


          if(protonGame(gameDB["steamID"]) !== "not found"){
            //need to show user protondb license agreement.
              document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML +=  "<li id ='proton-db'>ProtonDB: " + Math.round(protonGame(gameDB["steamID"])["compatibility"]*100) + "% <a onClick='openUrlInBrowser(`https://www.protondb.com/app/" + gameDB["steamID"] + "`)'<i class='fas fa-external-link-alt'></i></a></li>";
          }

          document.getElementsByClassName("game-info")[0].getElementsByTagName("ul")[0].innerHTML += "<div id='about-container'><div id ='about'>" + gameDB["info"]["littleDescriptionEN"] + "</div></div>";


          if(game["installed"]){
              if(game["installed-platforms"].includes("steam")){
                document.getElementsByClassName("game-settings")[0].getElementsByTagName("ul")[0].innerHTML += '<li  class="button-wide" onClick = "uninstallSteamGame(' + game["steamid"] +  ')"id="uninstall-button"><i class="fas fa-trash"></i> Uninstall Game</li><li class="button-wide" onClick = "backupSteamGame(' + game["steamid"] + ')"><i class="fas fa-compact-disc"></i> Backup</li>';
              }else if(game["installed-platforms"].includes("lutris")){
                  document.getElementsByClassName("game-settings")[0].getElementsByTagName("ul")[0].innerHTML += '<li class="button-wide" id="open-lutris" onClick = "openLutris()"><i class="fas fa-terminal"></i>  Open Lutris</li>';
              }
          }else{
            document.getElementsByClassName("game-settings")[0].getElementsByTagName("ul")[0].innerHTML += '<li class="button-wide" id="install-button" onClick = "installGame(`' + slug + '`)"><i class="fas fa-cloud-download-alt"></i>  Install Game</li>';
          }

          if(game["platforms"].includes("steam")){
            document.getElementsByClassName("game-settings")[0].getElementsByTagName("ul")[0].innerHTML +='<li class="button-wide" onClick="viewSteamGameScreenshots(' + game["steamid"] + ')" ><i class="fas fa-images"></i> View Screenshots</li> <li class="button-wide" onClick="viewSteamStorePage(' + game["steamid"] + ')" ><i class="fab fa-steam"></i> View Steam Store Page</li>';

            if(openSteamCommunityPage(gameDB["steamID"], true)){
              document.getElementsByClassName("game-settings")[0].getElementsByTagName("ul")[0].innerHTML +='<li class="button-wide" onClick="openSteamCommunityPage(' + game["steamid"] + ')" ><i class="fab fa-steam"></i> Steam Community Page</li>';
            }



          }




          showElement("game");
          document.getElementById("content").scroll(0,0);
          document.getElementById("current-section").innerHTML = slug;
          document.getElementById("current-page").innerHTML = "game"
          document.getElementById("game").setAttribute("scrolled-down", "false");

          if(!URLExists(logo, true)){
            document.getElementsByClassName("game-logo")[0].remove();
          }
        }

        async function addNewsToGamePage(steamID){
          var steamNews = await getSteamNews(steamID, count = 10);
          console.log(steamNews);
          document.getElementsByClassName("news-carousel")[0]. innerHTML = "";

          var x = 0;
          var numberOfCards  = steamNews["appnews"]["newsitems"].length;
          while(x< 3){
            newsItem = steamNews["appnews"]["newsitems"][x];
            var dateRaw = newsItem["date"];
            var unixDate = new Date(dateRaw * 1000);
            console.log(unixDate);
            var dateInTheFormatThatNormalHumansUse = unixDate.getDate() + "/" + (unixDate.getMonth() + 1) + "/" + unixDate.getFullYear();
            var contentsHTML = await new DOMParser().parseFromString(String(newsItem["contents"]), "text/html");
            try{
              var fallbackImage = await DBgameSTEAMID(steamID)["assets"]["screenshots"][Math.floor(Math.random()*DBgameSTEAMID(steamID)["assets"]["screenshots"].length)];

            }catch{
                var fallbackImage = await DBgameSTEAMID(steamID)["assets"]["header"];
            }


            try{
              var imgsrc = contentsHTML.getElementsByTagName("img")[0].src;

            }catch{
              imgsrc = fallbackImage;

            }
            document.getElementsByClassName("news-carousel")[0]. innerHTML += `
            <div class="news-card-game" onClick = "openUrlInBrowser('` + newsItem["url"] +`')"  style = "background-image: url('` +  produceImageUrl(fallbackImage) + `')">
              <div class="news-background-image"  style = "background-image: url('` +  produceImageUrl(imgsrc) + `')">
                <div class="news-card-meta">
                  <div class="news-card-title">
                    ` +  produceShortenedString(newsItem["title"], 48) +`
                  </div>
                  <div class="news-card-subtext">
                    <span class="news-card-author">` +  newsItem["feedlabel"] +`</span>|<span class="news-card-date">` +  dateInTheFormatThatNormalHumansUse + `</span>
                  </div>
                </div>

                <div class="news-card-contents">` /*+ newsItem["contents"]*/ +`
                </div>
              </div>
            </div>
            `;
            document.getElementById("news-text").innerHTML = "News";

            x++;
          }
        }

        async function getSteamNews(steamid, count = 10){
          var page = await getPage('https://api.steampowered.com/ISteamNews/GetNewsForApp/v2/?appid=' + steamid + '&count=' + count);
          var steamNews = await JSON.parse(page);
          return steamNews;
        }

        function produceShortenedString(string, characters){

          if(string.length<=characters){
            return string;
          }else{
            if(!string.substring(characters-1, characters).match(/[a-z]/i)){
              return string.substring(0,characters).slice(0, -1); + "...";
            }
            return string.substring(0,characters) + "...";
          }
        }


        function sortAchievementsByDate(achievements){

          orderedAchievements = []
          var unorderedAchievements = [];
          console.log(achievements);
          console.log(achievements.length);
          var x = 0;
          var numberOfDatedAchievements = 0
          while(x<achievements.length){
            var unlockTime = achievements[x]["achievementUnlockTime"];
            if(unlockTime == null){
              unixUnlock = 0;
              unorderedAchievements.push(achievements[x]);
            }else{
              numberOfDatedAchievements++;
              var unixUnlock = new Date(unlockTime).getTime() / 1000;
              if(typeof(orderedAchievements[unixUnlock])!== "undefined"){
                orderedAchievements[unixUnlock].push(x);
              }else{
                orderedAchievements[unixUnlock] = [];
                orderedAchievements[unixUnlock].push(x);
              }
            }


            x++;
          }
          console.log(orderedAchievements);
          var achievementsFinal = [];
          var x = 0;
          var keys = Object.keys(orderedAchievements)
          console.log(keys);
          while(x<keys.length){
            var y = 0;
            //console.log(orderedAchievements[keys[x]]);
            while(y<orderedAchievements[keys[x]].length){

              achievementsFinal.push(achievements[orderedAchievements[keys[x]][y]]);
              y++;
            }
            x++;
          }

            achievementsFinal.reverse();



          console.log(achievementsFinal);
          console.log(unorderedAchievements);
          allAchievements = achievementsFinal.concat(unorderedAchievements);
          return(allAchievements);
        }





        function getRecentlyPlayedGames(){

          orderedGames = []
          var unorderedGames = [];

          var x = 0;
          var numberOfDatedGames = 0
          while(x<usergames.length){
            var lastPlayed = usergames[x]["last-played"];
            if(lastPlayed == null){
              unorderedGames.push(usergames[x]);
            }else{
              numberOfDatedGames++;
              var unixLastPlayed = new Date(lastPlayed).getTime() / 1000;
              if(typeof(orderedGames[unixLastPlayed])!== "undefined"){
                orderedGames[unixLastPlayed].push(x);
              }else{
                orderedGames[unixLastPlayed] = [];
                orderedGames[unixLastPlayed].push(x);
              }
            }


            x++;
          }
          console.log(orderedGames);
          var gamesFinal = [];
          var x = 0;
          var keys = Object.keys(orderedGames)
          console.log(keys);
          while(x<keys.length){
            var y = 0;
            //console.log(orderedGames[keys[x]]);
            while(y<orderedGames[keys[x]].length){

              gamesFinal.push(usergames[orderedGames[keys[x]][y]]);
              y++;
            }
            x++;
          }

            gamesFinal.reverse();



          console.log(gamesFinal);
          console.log(unorderedGames);
          allGames = gamesFinal.concat(unorderedGames);
          return(allGames);
        }
    </script>


    <script>
       function produceRecentActivity(){
         hideElement("login-modal");
         showElement("app");
         hideElement("store");
         hideElement("game");
         showElement("library");
         showElement("sidebar");
         showElement("content-header");
         showElement("loading-big");

        document.getElementById("current-section").innerHTML = "recent-activity";
        document.getElementById("current-page").innerHTML = "library";
        document.getElementById("game").innerHTML = ""
        showElement("recent-activity");
        document.getElementById("recent-activity").innerHTML =`<div class ="inner"><div class="large-text-top" id="news-text">
          News and Updates
        </div>

        <div class="news-carousel"></div>

        <div class="large-text-top" id="recent-games-text">
          Recently played games
        </div>
        <div id='recent-games-row'></div>
        <div id="progress-and-community-wrapper">
          <div id='achievement-progress-container'></div>
          <div id="steam-community-feed">
          <div class="large-text-top" id="community-feed-text">
            From the Steam Community...
          </div>
            <div id="steam-community-feed-feed">
              <div class="steam-community-feed-item"></div>
              <div class="steam-community-feed-item"></div>
              <div class="steam-community-feed-item"></div>
              <div class="steam-community-feed-item"></div>

            </div>
          </div>
        </div>

        <div class="large-text-top" id="library-text">
          Library
        </div>
        </div>
        `;


        setTimeout(async function(){
          var recentGames = await getRecentlyPlayedGames();
          var x = 0;

          while(x<7){
            var slug  = recentGames[x]["slug"];
            console.warn(slug);
            document.getElementById("recent-games-row").innerHTML += await produceLibraryCard(slug,true);
            x++;
          }







          var x = 0;

          var maximumGamesNumerator = 5;
          while(x< maximumGamesNumerator + 1 && x<recentGames.length){
            var achievements = null;
            var game = recentGames[x];
            var achievementsFirst = game["achievements-steam"];

            if(typeof(achievementsFirst) == "undefined"){
                if(typeof(game["achievements-origin"]) == "undefined"){
                  var achievementsFirst = game["achievements-gog"];
                }else{
                  var achievementsFirst = game["achievements-origin"];
                }


            }
            try{
              var achievements =  sortAchievementsByDate(achievementsFirst);

            }catch{

            }



            if(typeof(achievements) !== "undefined" && achievements !== null){
              console.log(recentGames[x]["last-played"]  + ":  lastplayed | "  + recentGames[x]["slug"] );
              console.log(achievements);
              var z = 0;
              var achievementsFromDay = [];
              while(z<achievements.length){
                if(typeof(recentGames[x]["last-played"]) !== "undefined"){
                  var lastPlayed = recentGames[x]["last-played"];
                }
                else{
                    var lastPlayed = achievements[0]["achievementUnlockTime"];
                }
                  if(achievements[z]["achievementUnlocked"] == "true"){

              //    console.log( recentGames[x]["last-played"]);
              //      console.log( recentGames[x]["achievementUnlockTime"]);


                    if(achievements[z]["achievementUnlockTime"] == lastPlayed){
                      achievementsFromDay.push(achievements[z])
                      console.warn(achievementsFromDay);
                    }
                  }

                z++;
              }
              if(achievementsFromDay.length > 0){
                var newAchievement = true;
              }else{
                var newAchievement = false;
              }
              var achievementsFromDay = achievementsFromDay.concat(achievements.slice(achievementsFromDay.length, achievements.length));
              if(achievementsFromDay.length > 0 && typeof(lastPlayed) !== "undefined" && lastPlayed !== null){
                  document.getElementById("achievement-progress-container").innerHTML += `
                  <div  onClick = "showGame('` + recentGames[x]["slug"] +  `')" class='achievement-highlight-container' id='achievement-highlight-container-` + x +`'>
                    <div class='big-achievement-left'>
                    </div>
                    <div class='right-achievements-container'>
                    <div class='achievement-activity-title'>
                    <div class='achievement-name'>` + achievementsFromDay[0]["achievementName"] +`</div>
                    <div class='achievement-description'>` + achievementsFromDay[0]["achievementDescription"] +`</div>
                    </div>
                    <div class='small-achievements-right'></div>
                    </div><div class='completion-details'>
                    <div class='achievement-progress-title'>` +  recentGames[x]["name"] + `</div>
                    <div class='last-played'>Last Played ` + lastPlayed.split("-").reverse().join("/") + `</div>
                    <div class='completion'>` + calculateGameCompletion(recentGames[x]["slug"]) + `% Completion</div></div>
                  </div>`;




                var y = 0;
                while(y<5){

                  if(achievementsFromDay[y]["achievementUnlocked"] == "true"){
                    var unlockedText = "unlocked";
                  }else{
                    var unlockedText = "locked";

                  }
                  if(achievementsFromDay[y]["achievementDescription"] !== "null" & typeof(achievementsFromDay[y]["achievementDescription"]) !== "undefined"){
                            var achievementDescription    =      `<div class="achievement-description"> ` + achievementsFromDay[y]["achievementDescription"] + ` </div>`;
                   }else{
                     var achievementDescription = ""
                   }

                   if(typeof(achievementsFromDay[y]["achievementRarity"]) !== "undefined"){

                     if(achievementsFromDay[y]["achievementRarity"] < 5){
                       var rarityText = "rare";
                     }else if(achievementsFromDay[y]["achievementRarity"] < 20){
                       var rarityText = "uncommon";
                     }else if(achievementsFromDay[y]["achievementRarity"] < 40){
                       var rarityText = "medium";
                     }else if(achievementsFromDay[y]["achievementRarity"] < 60){
                       var rarityText = "common";
                     }
                     console.log(rarityText);
                     var achievementRarity = `<div class="achievment-rarity">
                       <span class="rarity-percentage">` + achievementsFromDay[y]["achievementRarity"] + `%</span> of users have this achievement
                     </div> `;
                   }else{
                      var achievementRarity = "";
                      var rarityText = "common";
                    }
                    try{
                      var unlockTime =achievementsFromDay[y]["achievementUnlockTime"];
                      console.log(unlockTime);
                      var unlockTimeNormal = unlockTime.split("-").reverse().join("/")
                    }catch{
                      var unlockTime =achievementsFromDay[y]["achievementUnlockTimeRaw"];

                    }


                    if(y === 0){
                      var targetDiv = document.getElementById('achievement-highlight-container-' + x).getElementsByClassName("big-achievement-left")[0];
                    }else{
                      var targetDiv = document.getElementById('achievement-highlight-container-' + x).getElementsByClassName("small-achievements-right")[0];
                    }


                  targetDiv.innerHTML += `<div class="achievement-game ` + unlockedText + ` ` + rarityText + `">
                    <div class="achievement-badge" style="background-image: url('` + produceImageUrl(achievementsFromDay[y]["achievementImage"]) +`')">

                    </div>
                    <div class="achievement-onclick-description">
                      <div class="achievement-name">`
                      + achievementsFromDay[y]["achievementName"] +  `        </div> ` + achievementDescription + `

                      <div class="achievment-unlock-date"> Unlocked on
                        ` + unlockTimeNormal + `
                      </div> ` + achievementRarity + `</div>
                  </div>`;
                  y++;
                }
              }else{
                maximumGamesNumerator++;
              }
                //console.warn(achievementsFromDay);
            }
            x++;
          }
        },500);

        var recentGames = getRecentlyPlayedGames();

        addNewsToRecentPage();
        produceSteamCommunityFeedMainpage();
      }


      async function produceSteamCommunityFeedMainpage(){
        try{



          document.getElementById("steam-community-feed-feed").innerHTML = "";
          var recentGames = await getRecentlyPlayedGames();
          var steamCommunityFeedImages = []
          var x  = 0;
          while(x < recentGames.length && x < 4){
            var steamID = recentGames[x]["steamid"];
            if(typeof(steamID) == "undefined"){
              var steamID = (await DBgameSLG(recentGames[x]["slug"]))["steamID"]
            }
            var steamCommunityFeedImages = steamCommunityFeedImages.concat(await getSteamCommunityScreenshots(steamID));
            x++;
          }


          console.log(steamCommunityFeedImages);
          var x=0;
          var producedImages = [];
          while(x<4){
            var image = steamCommunityFeedImages[Math.floor(Math.random()*steamCommunityFeedImages.length)];
            if(producedImages.includes(image)){
            //  document.getElementById("steam-community-feed-feed").innerHTML += "duplicate";
              var image = steamCommunityFeedImages[Math.floor(Math.random()*steamCommunityFeedImages.length)];
            }
            document.getElementById("steam-community-feed-feed").innerHTML += `<div class="steam-community-feed-item" style= "background-image: url('` +  produceImageUrl(image) + `')"> </div>`
            producedImages.push(image);
            x++;
          }
        }catch{

        }

      }


      async function addNewsToRecentPage(){
        try{

          var steamNews = []
          var recentGames = getRecentlyPlayedGames();
          var y = 0;
          while(y<8){

            var steamID = recentGames[y]["steamid"];
            if(typeof(steamID) == "undefined"){
              var steamID = (await DBgameSLG(recentGames[y]["slug"]))["steamID"];
            }
            console.warn(steamID);

            if(typeof(steamID) !== "undefined"){
              var steamNewsPage = await getSteamNews(steamID, count = 1);

              console.log(steamNewsPage);
              steamNews.push(steamNewsPage["appnews"]["newsitems"][0]);
            }
            y++;
          }
          console.log(steamNews);

          document.getElementsByClassName("news-carousel")[0]. innerHTML = "";

          var x = 0;
          while(x< 5){
            document.getElementById("current-section").innerHTML = "recent-activity";
            newsItem = steamNews[x];
            var dateRaw = newsItem["date"];
            var unixDate = new Date(dateRaw * 1000);
            console.log(unixDate);
            var dateInTheFormatThatNormalHumansUse = unixDate.getDate() + "/" + (unixDate.getMonth() + 1) + "/" + unixDate.getFullYear();
            var contentsHTML = await new DOMParser().parseFromString(String(newsItem["contents"]), "text/html");
            try{
              var fallbackImage =  (await DBgameSLG(recentGames[x]["slug"]))["assets"]["screenshots"][Math.floor(Math.random()*recentGames[x]["assets"]["screenshots"].length)];

            }catch{
                  var fallbackImage = (await DBgameSLG(recentGames[x]["slug"]))["assets"]["header"];


            }


            try{
              var imgsrc = contentsHTML.getElementsByTagName("img")[0].src;

            }catch{
              imgsrc = fallbackImage;

            }
            document.getElementsByClassName("news-carousel")[0]. innerHTML += `
            <div class="news-card-game" onClick = "openUrlInBrowser('` + newsItem["url"] +`')"  style = "background-image: url('` +  produceImageUrl(fallbackImage) + `')">
              <div class="news-background-image"  style = "background-image: url('` +  produceImageUrl(imgsrc) + `')">
                <div class="news-card-meta">
                  <div class="news-card-title">
                    ` +  produceShortenedString(newsItem["title"], 48) +`
                  </div>
                  <div class="news-card-subtext">
                    <span class="news-card-author">` +  newsItem["feedlabel"] +`</span>|<span class="news-card-date">` +  dateInTheFormatThatNormalHumansUse + `</span>
                  </div>
                </div>

                <div class="news-card-contents">` /*+ newsItem["contents"]*/ +`
                </div>
              </div>
            </div>
            `;
            document.getElementById("news-text").innerHTML = "News";

            x++;
          }
        }catch{

        }



        hideElement("loading-big");
        adjustWindowSize(900 ,650);
        maximiseWindow();
        setInterval(function(){
          refreshBackgroundImages();
        },2.5* 1000);
      }


      function calculateGameCompletion(slug){
          var game= usergamesSLG(slug);
        var achievementsFirst = game["achievements-steam"];
        if(typeof(achievementsFirst) == "undefined"){
            if(typeof(game["achievements-origin"]) == "undefined"){
              var achievementsFirst = game["achievements-gog"];
            }else{
              var achievementsFirst = game["achievements-origin"];
            }


        }
        try{
          var achievements =  sortAchievementsByDate(achievementsFirst);

        }catch{

        }
        if(typeof(achievements) == "undefined"){
          return;
        }else
        {
          var x = 0;
          var completedAchievements = 0;
          var unachieved = 0;
          while(x<achievements.length){
            if(achievements[x]["achievementUnlocked"] == "true"){
              completedAchievements++;
            }
            x++;
          }
          return(Math.round((completedAchievements/achievements.length)*100));
        }
      }




      async function getSteamCommunityScreenshots(steamID){
        var page = await getPageSourceHTML("https://steamcommunity.com/app/" + steamID + "/screenshots/?p=1&browsefilter=trendthreemonths");
        var images = page.getElementsByClassName("apphub_CardContentPreviewImage");
        var imagesSrc = []
        var x = 0;
        while(x<images.length){
          imagesSrc.push("https://" + gitBetween(images[x].src, "https://", "?"));
          x++;
        }
        return(imagesSrc);
      }
    </script>

    <script>
      async function calculateDiscountPercentage(slug, returnType = "discountPercent"){
        var game = await DBgameSLG(slug);

        var msrp = game["pricing"]["msrp"];

        if(typeof(msrp) == "undefined"){
          return 0;
        }else{
          var price = null;
          if(typeof(game["pricing"]["currentSteamPriceGBP"]) !== "undefined" && userinfo["config"]["allowed-pricing-stores"].includes("steam")){
            var pricetmp = game["pricing"]["currentSteamPriceGBP"];
            if(pricetmp < price || price == null){
              price = pricetmp;
              var store = "steam";
            }

          }
          if(typeof(game["pricing"]["currentGogPriceGBP"]) !== "undefined" && userinfo["config"]["allowed-pricing-stores"].includes("gog")){
            var pricetmp = game["pricing"]["currentGogPriceGBP"];
            if(pricetmp < price || price == null){
              price = pricetmp;
              var store = "gog";
            }

          }
          if(typeof(game["pricing"]["currentFanaticalPriceGBP"]) !== "undefined" && userinfo["config"]["allowed-pricing-stores"].includes("fanatical")){
            var pricetmp = game["pricing"]["currentFanaticalPriceGBP"];
            if(pricetmp < price || price == null){
              price = pricetmp;
              var store = "fanatical";
            }

          }
          if(typeof(game["pricing"]["currentHumblePriceGBP"]) !== "undefined" && userinfo["config"]["allowed-pricing-stores"].includes("humble")){
            var pricetmp = game["pricing"]["currentHumblePriceGBP"];
            if(pricetmp < price || price == null){
              price = pricetmp;
              var store = "humble";
            }

          }
          var discountPercentage = ((msrp - price) / msrp);

          if(returnType == "lowestPrice"){
            return price;
          }else if(returnType == "lowestStore"){
            return store;
          }else if(returnType == "discountPercent"){
            return discountPercentage;
          }




        }



      }

      async function getOnsaleGames(){
        var wishlist = userinfo["wishlist"];
        var onSale= []
        var x = 0;
        while (x<wishlist.length){
          try{
                      var discount = await calculateDiscountPercentage(wishlist[x]);
          }catch{
            var discount = 0;
          }

          if((discount*100) > 5){
            onSale.push(wishlist[x]);
          }
          x++;
        }

        return onSale;
      }

      async function checkForUserOnsaleGamesAndNotify(){
        var onsale = await getOnsaleGames();

        if(onsale.length == 1){
          var discountPercent = (await calculateDiscountPercentage(onSale[0]))*100 ;
          if(discountPercent > 25){
            console.log(onSale[0] + " is now discounted by " + discountPercent + "%");
            document.getElementById("wishlist-notification-content-text").innerHTML  = onSale[0] + " is now discounted by " + discountPercent + "%";
          }else{
            console.log(onSale[0] + " is on sale");
            document.getElementById("wishlist-notification-content-text").innerHTML  = onSale[0] + " is on sale";
          }
        }else{
          console.log(onsale.length + " games from your wishlist are now on sale");
          document.getElementById("wishlist-notification-content-text").innerHTML = onsale.length + " games from your wishlist are now on sale";

        }

        document.getElementById("wishlist-notification-content-headers").innerHTML = "";
        var x= 0;
        while(x<onsale.length){
          document.getElementById("wishlist-notification-content-headers").innerHTML +=  `<div class="wishlist-notification-content-header"  onclick="loadStoreSection('wishlist', 'onSaleOnly')" style="background-image: url('` + produceImageUrl((await DBgameSLG(onsale[x]))["assets"]["header"]) +  `')">`;
          x++;
        }
        if(onsale.length > 0){
          showElement("wishlist-notification");

        }

      }



      var currentWishlistGameShown = 0;
      var wishlistGameData = [];
      async function cycleWishlistGames(){
        if(document.getElementById("wishlist-notification").getAttribute("style") !== "display: none;"){
          var onsale = await getOnsaleGames();
          currentWishlistGameShown++;
          if(currentWishlistGameShown>=onsale.length){
            currentWishlistGameShown = 0;
          }
          var headers = document.getElementsByClassName("wishlist-notification-content-header");

          var x  = 0;

          while(x<headers.length){
            headers[x].style  = "display:none; ";
            x++;
          }
          if(wishlistGameData.length <= currentWishlistGameShown){
            wishlistGameData.push(await DBgameSLG(onsale[currentWishlistGameShown]));
            headers[currentWishlistGameShown].style = "background-image: url( " + produceImageUrl((await DBgameSLG(onsale[currentWishlistGameShown]))["assets"]["header"]) + ");";

          }
          headers[currentWishlistGameShown].style = "background-image: url( " + produceImageUrl(wishlistGameData[currentWishlistGameShown]["assets"]["header"]) + ");";
        }
      }

      setInterval(function(){
        if(document.getElementById("wishlist-notification").style !== "display: none;"){
          cycleWishlistGames();
        }

      },2500);


    </script>

    <script>
      function searchUserslugs(searchValue){
        var searchSlug = produceSlug(searchValue);
        var returnedValues = []
        var x = 0;

        while (x<userslugsGlobal.length){
          if(userslugsGlobal[x].includes(searchSlug)){
            returnedValues.push(userslugsGlobal[x]);
            //console.log("was found using raw string " + userslugsGlobal[x]);
          }
          x++;
        }

        var x = 0;
        var searchWords = searchSlug.split("-");
        while(x<searchWords.length){
          var y = 0;
          while (y<userslugsGlobal.length){
            if(userslugsGlobal[y].includes(searchWords[x])){
              returnedValues.push(userslugsGlobal[y]);
            }
            y++;
          }
          x++;
        }


        var withoutDuplicatesReturnArray = uniq = [...new Set(returnedValues)];
        return withoutDuplicatesReturnArray;
      }

      var searchBoxActive = false;
      var currentKey;
      var modalActive = false;
      document.addEventListener('keydown', function(event) {
          currentKey = event.key;
          if(searchBoxActive){
            var searchtext = document.getElementById("search-text").innerHTML;

          }else{
              document.getElementById("search-text").innerHTML = "";
          }

          if(checkKeyInput(currentKey) && (document.getElementById("current-page").innerHTML == "library" || document.getElementById("current-page").innerHTML == "game"  || document.getElementById("current-page").innerHTML == "store")){
            showElement("search-box");
            searchBoxActive  = true;
          }
          if(searchBoxActive && checkKeyInput(currentKey)){
            document.getElementById("search-text").innerHTML += currentKey;
          }


          else if(currentKey == "Backspace" && searchBoxActive){
            document.getElementById("search-text").innerHTML = searchtext.substring(0, searchtext.length - 1);


          }else if(currentKey == "Escape" && searchBoxActive){
            hideElement("search-box");
            searchBoxActive = false;
          }else if(currentKey == "Enter" && searchBoxActive){
            hideElement("search-box");
            searchBoxActive = false;
            showGame(document.getElementsByClassName("search-result")[0].getAttribute("slug"));
          }

          if(searchBoxActive){
            var searchtext = document.getElementById("search-text").innerHTML;
            var searchResults = produceSearchResults(searchtext)
          }

      });

      async function produceSearchResults(searchText){
        var searchResults = searchUserslugs(searchText);

          var x = 0;

          document.getElementById("search-results").innerHTML = "";

          while(x<searchResults.length ){
            var game = await DBgameSLG(searchResults[x]);
            if(game !== "not found"){
              document.getElementById("search-results").innerHTML += `

              <div class="search-result" onclick="showGame('` + searchResults[x] +`')" slug= "` + searchResults[x] +`">
                <div class="search-result-header" style="background-image: url('` /*+ produceImageUrl(game["assets"]["header"])*/ +`')">

                </div>
                <div class="search-result-contents">
                  <div class="search-result-title">
                    ` + game["appName"] + `
                  </div>
                  <div class="search-result-further-info">
                    ` + game["info"]["developers"][0] + ` | ` + game["info"]["publishers"][0]   + `
                  </div>
                </div>
              </div>`;
            }
            x++;
          }

      }
      function checkKeyInput(input){

        var alphabetNum = "qwertyuiopasdfghjklzxcvbnm QWERTYUIOPASDFGHJKLZXCVBNM 1234567890";
        if(modalActive){
          return false;
        }
        if(alphabetNum.includes(input)){
          return true;
        }
      }


      setInterval(function(){
        console.clear();
      },1000*60*5);

    </script>


  </body>
</html>
